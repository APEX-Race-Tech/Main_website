<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Insight | APEX Race Technologies</title>
    <meta name="description" content="Download Race Insight - The advanced data analysis tool for sim racers. Analyze racing data, compare laps, and improve your racing performance with professional-grade tools.">
    <meta name="keywords" content="race insight, sim racing, data analysis, lap comparison, racing data, APEX Race Technologies, racing software, data analysis, racing tools">
    <meta name="author" content="APEX Race Technologies">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://apexracetech.in/race-insight.html">
    
    <!-- Favicon -->
    <link rel="icon" type="image/webp" href="assets/app_icon.webp">
    <link rel="apple-touch-icon" href="assets/app_icon.webp">
    
    <!-- Preload critical resources for faster LCP -->
    <link rel="preload" as="image" href="assets/app_icon.webp" fetchpriority="high" crossorigin="anonymous" type="image/webp">
    <link rel="preload" as="image" href="assets/ri_images/Comparision%20laps.webp" fetchpriority="high" crossorigin="anonymous" type="image/webp">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://apexracetech.in/race-insight.html">
    <meta property="og:title" content="Race Insight | APEX Race Technologies">
    <meta property="og:description" content="Download Race Insight - The advanced data analysis tool for sim racers. Analyze racing data, compare laps, and improve your racing performance.">
    <meta property="og:image" content="https://apexracetech.in/assets/images/RI_round_logo.webp">
    <meta property="og:site_name" content="APEX Race Technologies">
    <meta property="fb:app_id" content="YOUR_FACEBOOK_APP_ID">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://apexracetech.in/race-insight.html">
    <meta name="twitter:title" content="Race Insight | APEX Race Technologies">
    <meta name="twitter:description" content="Download Race Insight - The advanced data analysis tool for sim racers. Analyze racing data, compare laps, and improve your racing performance.">
    <meta name="twitter:image" content="https://apexracetech.in/assets/images/RI_round_logo.webp">
    
    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "Race Insight",
        "applicationCategory": "Data Analysis Application",
        "operatingSystem": "Windows, Linux, macOS",
        "description": "Advanced data analysis tool for motorsport racers. Analyze racing data, compare laps, and improve your racing performance with professional-grade tools.",
        "publisher": {
            "@type": "Organization",
            "name": "APEX Race Technologies",
            "url": "https://apexracetech.in"
        },
        "screenshot": "https://apexracetech.in/assets/images/lap_comparison_ui.webp",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD",
            "availability": "https://schema.org/InStock"
        }
    }
    </script>
    <!-- Preconnect to external resources for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com">
    
    <!-- Font Awesome - load early for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" 
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" 
          crossorigin="anonymous" referrerpolicy="no-referrer">
    
    <!-- Google Fonts with font-display swap for better performance -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Local Stylesheets -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/race-insight.css">
    
    <!-- Polyfills for Edge compatibility -->
    <script>
        // Polyfill for optional chaining and nullish coalescing for older Edge versions
        if (!Object.prototype.hasOwnProperty.call(Object.prototype, 'hasOwnProperty')) {
            Object.defineProperty(Object.prototype, 'hasOwnProperty', {
                value: function(prop) {
                    return Object.prototype.hasOwnProperty.call(this, prop);
                }
            });
        }
        
        // Ensure Promise and fetch are available (should be in modern Edge, but just in case)
        if (typeof Promise === 'undefined') {
            console.warn('Promise not supported - this browser is too old');
        }
        
        // Polyfill for Array.find if needed (should be available in Edge, but adding for safety)
        if (!Array.prototype.find) {
            Array.prototype.find = function(predicate) {
                if (this == null) {
                    throw new TypeError('Array.prototype.find called on null or undefined');
                }
                if (typeof predicate !== 'function') {
                    throw new TypeError('predicate must be a function');
                }
                var list = Object(this);
                var length = parseInt(list.length) || 0;
                var thisArg = arguments[1];
                var value;
                for (var i = 0; i < length; i++) {
                    value = list[i];
                    if (predicate.call(thisArg, value, i, list)) {
                        return value;
                    }
                }
                return undefined;
            };
        }
    </script>
    
    <!-- Firebase SDKs (Compat) - Deferred to improve initial page load -->
    <script defer src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TQNN66RBKN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-TQNN66RBKN', {
            cookie_flags: 'SameSite=None;Secure'
        });
    </script>
    <!-- Suppress Cloudflare beacon errors (external script) -->
    <script>
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('cloudflareinsights.com')) {
                e.preventDefault();
                return false;
            }
        }, true);
    </script>
</head>

<body>
    <!-- Social Media Bar -->
    <div class="social-media-bar">
        <div class="follow-prompt">
            <img src="assets/arrow.webp" alt="Follow us on social media" class="follow-arrow-img">
        </div>
        <div class="social-icons-container">
            <a href="https://www.instagram.com/apex.race.tech/" class="social-icon" target="_blank"
                rel="noopener noreferrer" aria-label="Follow us on Instagram"><i class="fab fa-instagram"></i></a>
            <a href="https://twitter.com/apexracetech" class="social-icon" target="_blank" rel="noopener noreferrer" aria-label="Follow us on Twitter/X"><i
                    class="fa-brands fa-x-twitter"></i></a>
            <a href="#" class="social-icon" style="opacity: 0.5; cursor: not-allowed; pointer-events: none;" aria-label="LinkedIn (coming soon)" title="LinkedIn coming soon"><i
                    class="fab fa-linkedin-in"></i></a>
            <a href="https://discord.gg/gednFunCrv" class="social-icon" target="_blank" rel="noopener noreferrer" aria-label="Join our Discord"><i
                    class="fab fa-discord"></i></a>
        </div>
    </div>

    <header class="header">
        <nav class="nav-container">
            <a href="index.html" class="header__logo">
                <img src="assets/images/apex_orange_Horizontal.svg" alt="APEX Race Technologies Logo" class="logo--full"
                    style="filter: hue-rotate(190deg) brightness(1.2);">
                <img src="assets/images/apex_orange_ONLY LOGO.svg" alt="APEX Race Technologies Icon" class="logo--icon"
                    style="filter: hue-rotate(190deg) brightness(1.2);">
            </a>
            <div class="nav-right">
                <ul class="nav-links">
                    <li><a href="https://docs.apexracetech.in" target="_blank" rel="noopener noreferrer">Docs</a></li>
                </ul>
                <div class="header-action-item">
                    <button id="nav-signin-btn" class="btn-text-signin">Sign In</button>
                    <button id="nav-profile-btn" class="btn-profile-icon" aria-label="Profile" title="Profile" style="display: none;">
                        <i class="fas fa-user"></i>
                    </button>
                    <a href="#download" class="btn btn-primary" id="nav-download-btn" aria-label="Download Race Insight">Download</a>
                </div>
            </div>
            <button class="hamburger-btn" aria-label="Toggle menu">
                <span class="hamburger-btn__bar"></span>
                <span class="hamburger-btn__bar"></span>
                <span class="hamburger-btn__bar"></span>
            </button>
        </nav>
    </header>

    <div class="mobile-nav">
        <ul class="nav-links">
            <li><a href="https://docs.apexracetech.in" target="_blank" rel="noopener noreferrer">Docs</a></li>
        </ul>
        <div class="header-action-item">
            <button id="mobile-nav-profile-btn" class="btn-profile-icon" style="margin-bottom: 0.5rem; display: none;" aria-label="Profile">
                <i class="fas fa-user"></i>
            </button>
            <a href="#download" class="btn btn-primary" id="mobile-nav-download-btn" aria-label="Download Race Insight">Download</a>
        </div>
    </div>

    <section id="race-insight-hero" class="full-page-section">
        <div class="section-content">
            <div class="hero-logo-container">
                <img src="assets/app_icon.webp" alt="Race Insight Logo" class="hero-logo" decoding="async">
            </div>
            <div class="hero-text-wrapper">
                <h1 class="hero-title">Race Insight</h1>
                <p class="tagline">The Motorsport Data Analysis Platform</p>
                <blockquote class="hero-quote">
                    <p>"Without data you're just another person with an opinion"</p>
                    <cite>— W. Edward Deming</cite>
                </blockquote>
                <div class="hero-content">
                    <p class="hero-description">Analyze your Data, compare Laps, and improve your Delta with
                        professional-grade data analysis.</p>
                    <div class="hero-actions">
                        <a href="#download" class="btn btn-primary" aria-label="Get started with Race Insight download">Get Started</a>
                        <a href="#data-import" class="btn btn-secondary" aria-label="Learn more about Race Insight features">Learn More</a>
                    </div>
                    <a href="#download" class="hero-badge" style="cursor: pointer; text-decoration: none; display: inline-block;" aria-label="Download Race Insight Beta">Now Available in Beta</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Image Slideshow -->
    <section id="hero-slideshow" class="slideshow-section">
        <div class="slideshow-container">
            <div class="slideshow-wrapper">
                <div class="slide active">
                    <img src="assets/ri_images/Comparision%20laps.webp" alt="Lap Comparison" class="slide-image" loading="eager" fetchpriority="high">
                    </div>
                    <div class="slide">
                        <img src="assets/ri_images/Dataoverview.webp" alt="Data Overview" class="slide-image" loading="lazy">
                    </div>
                    <div class="slide">
                        <img src="assets/ri_images/satilite.webp" alt="Satellite View" class="slide-image" loading="lazy">
                </div>
            </div>
            
            <!-- Navigation Arrows -->
            <button class="slideshow-nav slideshow-prev" aria-label="Previous slide">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="slideshow-nav slideshow-next" aria-label="Next slide">
                <i class="fas fa-chevron-right"></i>
            </button>
            
            <!-- Slide Indicators -->
            <div class="slideshow-indicators">
                <span class="indicator active" data-slide="0" aria-label="Slide 1"></span>
                <span class="indicator" data-slide="1" aria-label="Slide 2"></span>
                <span class="indicator" data-slide="2" aria-label="Slide 3"></span>
            </div>
        </div>
    </section>

    <!-- Feature Sections -->
    <section id="data-import" class="full-page-section feature-section">
        <div class="section-content">
            <div class="section-header-card">
                <div class="section-header-icon">
                    <i class="fas fa-upload"></i>
                </div>
                <div class="section-header-text">
                    <h2 class="section-title">Data Import</h2>
                    <p class="section-subtitle">Seamless Ingestion for High-Performance Analysis</p>
                </div>
            </div>
            <div class="feature-content">
                <div class="feature-details style-minimal">
                    <div class="feature-detail-item innovative-card" data-card="1">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/lap_comparison_ui.webp" alt="Universal Format Support" class="card-image" style="display: none;" loading="lazy">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-globe" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>Universal Format Support</h4>
                            <p>Works with all the major racing data formats you already use. Whether your data comes from iRacing, MoTeC, AiM, RaceLogic, or custom CSV files, we've got you covered.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                    <div class="feature-detail-item innovative-card" data-card="2">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/telemetry_graphs_ui.webp" alt="High-Speed Processing" class="card-image" style="display: none;" loading="lazy">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-bolt" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>Lightning-Fast Processing</h4>
                            <p>Upload even the largest files (200MB+) and they're ready to analyze in seconds. No more waiting around for your data to load.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                    <div class="feature-detail-item innovative-card" data-card="3">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/track_map_ui.webp" alt="Offline Reliability" class="card-image" style="display: none;" loading="lazy">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-laptop" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>Works Offline</h4>
                            <p>Once you've imported your data, you can analyze it anywhere—even without internet. Perfect for working on the go or in areas with spotty connectivity.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="data-overview" class="full-page-section feature-section">
        <div class="section-content">
            <div class="section-header-card">
                <div class="section-header-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="section-header-text">
                    <h2 class="section-title">Data Management</h2>
                    <p class="section-subtitle">Intelligent Session Intelligence at a Glance</p>
                </div>
            </div>
            <div class="feature-content">
                <div class="feature-details style-minimal">
                    <div class="feature-detail-item innovative-card" data-card="1">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/track_map_ui.webp" alt="Advanced Session Queue" class="card-image" style="display: none;">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-filter" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>Smart Session filter</h4>
                            <p>Filter your racing sessions by track, driver, or car with intelligent filtering options. Sort by date, lap count, or fastest lap time to quickly narrow down to the exact sessions you need.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                    <div class="feature-detail-item innovative-card" data-card="2">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/lap_comparison_ui.webp" alt="Real-Time Previews" class="card-image" style="display: none;">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-tachometer-alt" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>Instant Performance Stats</h4>
                            <p>Click any session to see your key metrics at a glance—average lap times, how consistent you were, and your theoretical best lap.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                    <div class="feature-detail-item innovative-card" data-card="3">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/telemetry_graphs_ui.webp" alt="Interactive Spatial Previews" class="card-image" style="display: none;">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-eye" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>Visual Previews</h4>
                            <p>See track maps and lap-time trends right away, so you know what to expect before diving into detailed analysis.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="analysis" class="full-page-section feature-section">
        <div class="section-content">
            <div class="section-header-card">
                <div class="section-header-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="section-header-text">
                    <h2 class="section-title">Analysis</h2>
                    <p class="section-subtitle">High-Fidelity Visualization for Split-Second Decisions</p>
                </div>
            </div>
            <div class="feature-content">
                <div class="feature-details style-minimal">
                    <div class="feature-detail-item innovative-card" data-card="1">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/telemetry_graphs_ui.webp" alt="Professional Graphing Engine" class="card-image" style="display: none;">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-chart-line" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>Professional Graphing Engine</h4>
                            <p>Smooth graphs that display your racing data without any lag. Everything responds instantly as you explore your data.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                    <div class="feature-detail-item innovative-card" data-card="2">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/lap_comparison_ui.webp" alt="Synchronized Ecosystem" class="card-image" style="display: none;">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-sync-alt" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>Everything Connected</h4>
                            <p>Move your cursor on any graph and watch everything update together—track position, G-forces, and all your gauges move in perfect sync.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                    <div class="feature-detail-item innovative-card" data-card="3">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/track_map_ui.webp" alt="Multi-Lap Comparison" class="card-image" style="display: none;">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-columns" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>Easy Lap Comparison</h4>
                            <p>Compare any laps side-by-side, even if they were recorded at different rates. The system automatically aligns everything so you can see exactly where you gained or lost time.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="custom-workbook" class="full-page-section feature-section">
        <div class="section-content">
            <div class="section-header-card">
                <div class="section-header-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="section-header-text">
                    <h2 class="section-title">Custom workbook</h2>
                    <p class="section-subtitle">Your Modular Mission Control (AI workbook)</p>
                </div>
            </div>
            <div class="feature-content">
                <div class="feature-details style-minimal">
                    <div class="feature-detail-item innovative-card" data-card="1">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/telemetry_graphs_ui.webp" alt="AI-Driven Layout Generation" class="card-image" style="display: none;">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-brain" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>AI-Powered Creation</h4>
                            <p>Just describe what you want in plain English, and watch as your custom dashboard comes to life. No complex setup required.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                    <div class="feature-detail-item innovative-card" data-card="2">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/track_map_ui.webp" alt="Dynamic Workspace Canvas" class="card-image" style="display: none;">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-mouse-pointer" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>Drag-and-Drop Design</h4>
                            <p>Build your perfect workspace by simply dragging, resizing, and arranging widgets exactly where you want them. It's that easy.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                    <div class="feature-detail-item innovative-card" data-card="3">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/lap_comparison_ui.webp" alt="Modular Library" class="card-image" style="display: none;">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-th-large" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>Widget Library</h4>
                            <p>Choose from professional tools like speed dials, throttle/brake displays, tire monitors, and G-force gauges. Mix and match to create your ideal setup.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="data-export" class="full-page-section feature-section">
        <div class="section-content">
            <div class="section-header-card">
                <div class="section-header-icon">
                    <i class="fas fa-download"></i>
                </div>
                <div class="section-header-text">
                    <h2 class="section-title">Data Export</h2>
                    <p class="section-subtitle">Open Compatibility for Professional Workflows</p>
                </div>
            </div>
            <div class="feature-content">
                <div class="feature-details style-minimal">
                    <div class="feature-detail-item innovative-card" data-card="1">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/lap_comparison_ui.webp" alt="Standardized CSV Export" class="card-image" style="display: none;">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-file-csv" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>Export to CSV</h4>
                            <p>Save your analyzed data in a clean, easy-to-read format that works with Excel, MATLAB, and other tools you already use.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                    <div class="feature-detail-item innovative-card" data-card="2">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/telemetry_graphs_ui.webp" alt="PDF Report Export" class="card-image" style="display: none;">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-file-pdf" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>Export PDF Reports</h4>
                            <p>Generate professional PDF reports with your analysis, graphs, and insights—perfect for sharing with your team or keeping records of your performance improvements.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                    <div class="feature-detail-item innovative-card" data-card="3">
                        <div class="card-glow"></div>
                        <div class="card-image-wrapper">
                            <img src="assets/images/track_map_ui.webp" alt="Track Map Export" class="card-image" style="display: none;">
                            <div class="image-overlay" style="background: #000 !important; opacity: 1 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
                                <i class="fas fa-map-marked-alt" style="font-size: 4rem !important; color: #fff !important; opacity: 1 !important; z-index: 10 !important; position: relative !important; display: inline-block !important;"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4>Export Track Maps</h4>
                            <p>Save high-quality track maps with your lap data overlaid, ideal for presentations, documentation, or detailed track analysis.</p>
                        </div>
                        <div class="card-particles"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="features" class="full-page-section" style="display: none;">
        <div class="section-content">
            <div class="advantage-cards">
                <div class="advantage-card feature-card">
                    <img src="assets/images/lap_comparison_ui.webp" alt="Lap Comparison" class="feature-img">
                    <h4>Lap Comparison</h4>
                    <p>Compare multiple laps side-by-side to identify time gains and losses.</p>
                </div>
                <div class="advantage-card feature-card">
                    <img src="assets/images/telemetry_graphs_ui.webp" alt="Data Analysis" class="feature-img">
                    <h4>Advanced Data Analysis</h4>
                    <p>Dive deep into speed, throttle, brake, and steering data with precise graphs.</p>
                </div>
                <div class="advantage-card feature-card">
                    <img src="assets/images/track_map_ui.webp" alt="Track Mapping" class="feature-img">
                    <h4>Interactive Track Map</h4>
                    <p>Visualize your racing line and position on the track in real-time.</p>
                </div>
                <div class="advantage-card feature-card">
                    <div class="feature-icon-container">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <h4>Supported File Formats</h4>
                    <p style="padding-bottom: 0.5rem;">Compatible with popular data formats for seamless integration with your workflow.</p>
                    <ul class="file-format-list">
                        <li>MoTeC (.ld, .ldx)</li>
                        <li>CSV</li>
                        <li>JSON</li>
                        <li>VBOX (.vbo)</li>
                        <li>AIM (.drk, .xrk)</li>                    
                    </ul>
                </div>
                <div class="advantage-card feature-card">
                    <div class="feature-icon-container">
                        <i class="fas fa-th"></i>
                    </div>
                    <h4>Custom Workbook</h4>
                    <p>Create any type and size of layout you want for personalized data analysis.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="upcoming-updates" class="full-page-section">
        <div class="section-content">
            <h2 class="section-title">Coming Soon</h2>
            <p class="section-subtitle">We are constantly working to improve Race Insight. Here is what's next:</p>
            <div class="updates-grid">
                <div class="update-card">
                    <div class="update-icon"><i class="fas fa-video"></i></div>
                    <h4>Video Support</h4>
                    <p>Sync your onboard video with racing data for visual analysis.</p>
                </div>
                <div class="update-card">
                    <div class="update-icon"><i class="fas fa-globe"></i></div>
                    <h4>Cross Platform Support</h4>
                    <p>Full cross platform support across multiple devices.</p>
                </div>
                <div class="update-card">
                    <div class="update-icon"><i class="fas fa-stopwatch-20"></i></div>
                    <h4>Predictive Laps</h4>
                    <p>Real-time predictive lap timing to help you push your limits.</p>
                </div>
                <div class="update-card">
                    <div class="update-icon"><i class="fas fa-robot"></i></div>
                    <h4>Advanced Data Analysis</h4>
                    <p>Create custom graphs with prompts using AI-powered insights.</p>
                </div>
                <div class="update-card">
                    <div class="update-icon"><i class="fas fa-window-restore"></i></div>
                    <h4>Multi-Window Support</h4>
                    <p>Open multiple data views simultaneously for enhanced analysis and comparison.</p>
                </div>
                <div class="update-card">
                    <div class="update-icon"><i class="fas fa-map"></i></div>
                    <h4>Offline Maps</h4>
                    <p>Access track maps and data visualization without requiring an internet connection.</p>
                </div>
                <div class="update-card">
                    <div class="update-icon"><i class="fas fa-cloud"></i></div>
                    <h4>Multi Device Session Sync</h4>
                    <p>Sync your session data across multiple devices using cloud storage for seamless access anywhere.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="download" class="full-page-section">
        <div class="section-content">
            <div class="download-section">
                <h3>Download Race Insight</h3>
                <p>Choose your platform and start analyzing your racing data.</p>

                <div class="download-card" style="margin-bottom: 3rem;">
                <div id="total-download-container" class="counter-container" style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); display: none;">
                    <p style="margin: 0; font-size: 0.9rem; color: #aaa; margin-bottom: 0.5rem;">Total Downloads</p>
                    <div id="download-count" style="font-size: 2rem; font-weight: 700; color: #fff; font-variant-numeric: tabular-nums;">
                        <span style="opacity: 0.5;">Loading...</span>
                    </div>
                </div>
                </div>

                <div class="platform-options">
                    <button class="platform-btn" data-platform="windows"><i class="fab fa-windows"></i> Windows</button>
                    <button class="platform-btn disabled" data-platform="linux" disabled style="opacity: 0.5; cursor: not-allowed; pointer-events: none;"><i class="fab fa-linux"></i> Linux</button>
                    <button class="platform-btn disabled" data-platform="apple" disabled style="opacity: 0.5; cursor: not-allowed; pointer-events: none;"><i class="fab fa-apple"></i> Mac</button>
                </div>

                <div class="action-buttons">
                    <button id="download-btn" class="btn btn-primary">Download</button>
                </div>
            </div>
        </div>
    </section>

    <section id="feedback" class="full-page-section">
        <div class="section-content">
            <h2 class="section-title">
                <span style="font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem;">Share Your Feedback</span>
                <span style="font-size: 1.1rem; color: var(--text-color-secondary); text-align: center; line-height: 1.6; max-width: 500px;">
                    We value your input and suggestions. Help us improve Race Insight by sharing your thoughts, reporting issues, or suggest new features.
                </span>
            </h2>
            <form action="https://api.web3forms.com/submit" method="POST" class="contact-form"
                enctype="multipart/form-data">
                <input type="hidden" name="access_key" value="bfe30952-0ac8-4ece-b115-8965465d4035">
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="message">Message</label>
                    <textarea id="message" name="message" rows="5" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Send Feedback</button>
            </form>
        </div>
    </section>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content profile-modal-content">
            <button id="close-profile-modal" class="modal-close">&times;</button>
            <h2 class="section-title">Profile</h2>
            <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <div id="profile-avatar-initials" class="avatar-initials"></div>
                        <img id="profile-avatar-img" src="" alt="Profile" style="display: none; width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                    </div>
                    <div class="profile-info">
                        <h3 id="profile-display-name">Loading...</h3>
                        <p id="profile-email" style="color: var(--text-color-secondary); margin: 0;">Loading...</p>
                        <p id="profile-member-since" style="color: var(--text-color-secondary); font-size: 0.9rem; margin: 0;">Member since: Loading...</p>
                    </div>
                </div>

                <div class="profile-actions">
                    <button id="edit-profile-btn" class="btn btn-primary"><i class="fas fa-edit"></i> Edit Profile</button>
                    <button id="change-password-btn" class="btn btn-secondary"><i class="fas fa-key"></i> Passwords</button>
                    <button id="modal-logout-btn" class="btn btn-secondary" style="border-color: rgba(255,255,255,0.1); color: #fff; min-width: 48px;" aria-label="Logout" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                    <button id="delete-account-btn" class="btn btn-secondary" style="border-color: #ff4757; color: #ff4757;"><i class="fas fa-trash-alt"></i> Delete Account</button>
                </div>

                <div id="profile-edit-form" class="profile-edit-form" style="display: none;">
                    <h4>Edit Profile</h4>
                    <form id="update-profile-form">
                        <div class="form-group">
                            <label for="profile-name">Display Name</label>
                            <input type="text" id="profile-name" name="displayName" placeholder="Enter your display name">
                        </div>
                        <div class="form-group">
                            <label for="profile-bio">Bio (Optional)</label>
                            <textarea id="profile-bio" name="bio" rows="3" placeholder="Tell us about yourself"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="profile-location">Location</label>
                            <input type="text" id="profile-location" name="location" placeholder="City, Country">
                        </div>
                        <div class="form-group">
                            <label for="profile-simulator-edit">Primary simulator</label>
                            <select id="profile-simulator-edit" name="simulator" style="width: 100%; padding: 0.75rem; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white;">
                                <option value="">Select a Simulator</option>
                                <option value="iRacing">iRacing</option>
                                <option value="ACC">ACC</option>
                                <option value="Assetto Corsa">Assetto Corsa</option>
                                <option value="F1 Series">F1 Series</option>
                                <option value="rFactor 2">rFactor 2</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="profile-experience-edit">Racing experience</label>
                            <select id="profile-experience-edit" name="experience" style="width: 100%; padding: 0.75rem; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white;">
                                <option value="">Select Level</option>
                                <option value="Beginner">Beginner</option>
                                <option value="Intermediate">Intermediate</option>
                                <option value="Advanced">Advanced</option>
                                <option value="Professional">Professional</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Cancel</button>
                        </div>
                    </form>
                </div>

                <div id="change-password-form" class="profile-edit-form" style="display: none;">
                    <h4>Change Password</h4>
                    <form id="update-password-form">
                        <div class="form-group">
                            <label for="current-password">Current Password</label>
                            <input type="password" id="current-password" name="currentPassword" placeholder="Enter current password" required>
                        </div>
                        <div class="form-group">
                            <label for="new-password">New Password</label>
                            <input type="password" id="new-password" name="newPassword" placeholder="Enter new password" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">Confirm New Password</label>
                            <input type="password" id="confirm-password" name="confirmPassword" placeholder="Confirm new password" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Update Password</button>
                            <button type="button" id="cancel-password-btn" class="btn btn-secondary">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="profile-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="profile-simulator">N/A</div>
                        <div class="stat-label">Simulator</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="profile-experience">N/A</div>
                        <div class="stat-label">Experience</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="profile-referral" style="font-size: 1.1rem;">N/A</div>
                        <div class="stat-label">Discovery</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="profile-location-display" style="font-size: 1.1rem;">N/A</div>
                        <div class="stat-label">Location</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal-backdrop">
        <div class="modal-content">
            <button id="close-auth-modal" class="modal-close">&times;</button>
            <h3 id="auth-title">Sign In with Google</h3>
            <p id="auth-subtitle">Sign in with your Google account to access downloads and save your preferences.</p>

            <div class="auth-buttons">
                <button id="google-signin-btn" class="btn-google">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google"
                        width="18">
                    Sign in with Google
                </button>
            </div>

            <!-- Email form disabled - only Google sign-in available -->
            <div class="divider" style="display: none;"><span>OR</span></div>

            <!-- Step Indicator -->
            <div id="auth-step-indicator" class="auth-step-indicator" style="display: none; margin-bottom: 2rem;">
                <div class="step step-1 active" data-step="1"><span>1</span><label>Account</label></div>
                <div class="step-line"></div>
                <div class="step step-2" data-step="2"><span>2</span><label>Profile</label></div>
            </div>

            <div id="auth-error" class="auth-error" style="display: none; background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3); color: #ff6b6b; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;"></div>
            <div id="auth-success" class="auth-success" style="display: none; background: rgba(0, 255, 0, 0.1); border: 1px solid rgba(0, 255, 0, 0.3); color: #51cf66; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;"></div>

            <form id="email-auth-form" style="display: none;">
                <!-- Step 1: Credentials -->
                <div id="auth-step-1" class="auth-step">
                    <div class="form-group" style="position: relative; margin-bottom: 1.25rem;">
                        <i class="fas fa-envelope" style="position: absolute; left: 1rem; top: 0.9rem; color: #555; z-index: 1;"></i>
                        <input type="email" id="auth-email" placeholder="Email Address" required style="padding-left: 2.75rem; width: 100%; box-sizing: border-box;">
                    </div>
                    <div class="form-group" style="position: relative; margin-bottom: 1.25rem;">
                        <i class="fas fa-lock" style="position: absolute; left: 1rem; top: 0.9rem; color: #555; z-index: 1;"></i>
                        <input type="password" id="auth-password" placeholder="Password" required style="padding-left: 2.75rem; width: 100%; box-sizing: border-box;">
                        <div id="forgot-password-link" style="text-align: right; margin-top: 0.5rem; font-size: 0.85rem; display: none;">
                            <a href="#" id="forgot-password-btn" style="color: var(--primary-color); text-decoration: none;">Forgot Password?</a>
                        </div>
                    </div>
                    <div class="form-group" id="confirm-password-group" style="position: relative; margin-bottom: 1.25rem; display: none;">
                        <i class="fas fa-lock" style="position: absolute; left: 1rem; top: 0.9rem; color: #555; z-index: 1;"></i>
                        <input type="password" id="auth-confirm-password" placeholder="Confirm Password" style="padding-left: 2.75rem; width: 100%; box-sizing: border-box;">
                    </div>
                    <button type="button" id="auth-next-btn" class="btn btn-primary" style="width: 100%; display: none;">Next <i class="fas fa-arrow-right"></i></button>
                    <button type="submit" id="auth-submit-btn" class="btn btn-primary" style="width: 100%;">Sign In</button>
                </div>

                <!-- Step 2: Profile (Hidden by default, used only for Sign-Up) -->
                <div id="auth-step-2" class="auth-step" style="display: none;">
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label for="auth-simulator" style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #aaa;">Primary Racing Simulator</label>
                        <select id="auth-simulator" name="simulator" style="width: 100%; padding: 0.75rem; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white;">
                            <option value="">Select a Simulator</option>
                            <option value="iRacing">iRacing</option>
                            <option value="ACC">ACC</option>
                            <option value="Assetto Corsa">Assetto Corsa</option>
                            <option value="F1 Series">F1 Series</option>
                            <option value="rFactor 2">rFactor 2</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label for="auth-experience" style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #aaa;">Racing Experience</label>
                        <select id="auth-experience" name="experience" style="width: 100%; padding: 0.75rem; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white;">
                            <option value="">Select Level</option>
                            <option value="Beginner">Beginner</option>
                            <option value="Intermediate">Intermediate</option>
                            <option value="Advanced">Advanced</option>
                            <option value="Professional">Professional</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label for="auth-location" style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #aaa;">Where are you from?</label>
                        <input type="text" id="auth-location" placeholder="City, Country" style="width: 100%; padding: 0.75rem; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white; box-sizing: border-box;">
                    </div>
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label for="auth-referral" style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #aaa;">Where did you hear about us?</label>
                        <select id="auth-referral" name="referral" style="width: 100%; padding: 0.75rem; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white;">
                            <option value="">Select Source</option>
                            <option value="Social Media">Social Media</option>
                            <option value="YouTube">YouTube</option>
                            <option value="Discord">Discord</option>
                            <option value="Friend">Friend</option>
                            <option value="Search">Search</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" id="auth-back-btn" class="btn btn-secondary" style="flex: 1;">Back</button>
                        <button type="submit" id="auth-signup-submit-btn" class="btn btn-primary" style="flex: 2;">Finish Sign Up</button>
                    </div>
                </div>
            </form>

            <div class="auth-switch" style="display: none;">
                <p id="auth-switch-text">Don't have an account? <a href="#" id="toggle-auth-mode">Sign Up</a></p>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboarding-modal" class="modal-backdrop" style="display: none;" data-no-close="true">
        <div class="modal-content" onclick="event.stopPropagation();">
            <h3>Complete Your Profile</h3>
            <p>Tell us a bit more about your racing setup to personalize your experience.</p>
            
            <form id="onboarding-form">
                <div class="form-group">
                    <label for="onboarding-simulator">Primary Racing Simulator</label>
                    <select id="onboarding-simulator" name="simulator" required style="width: 100%; padding: 0.75rem; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white;">
                        <option value="">Select a Simulator</option>
                        <option value="iRacing">iRacing</option>
                        <option value="Assetto Corsa Competizione">Assetto Corsa Competizione (ACC)</option>
                        <option value="Assetto Corsa">Assetto Corsa</option>
                        <option value="F1 23/24">F1 23/24</option>
                        <option value="Le Mans Ultimate">Le Mans Ultimate</option>
                        <option value="rFactor 2">rFactor 2</option>
                        <option value="BeamNG.drive">BeamNG.drive</option>
                        <option value="Other">Other</option>
                    </select>
                    <textarea id="onboarding-simulator-other" name="simulator-other" placeholder="Please specify your simulator" style="width: 100%; padding: 0.75rem; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white; margin-top: 0.5rem; display: none; min-height: 80px; resize: vertical; font-family: inherit;"></textarea>
                </div>
                <div class="form-group">
                    <label for="onboarding-experience">Racing Experience</label>
                    <select id="onboarding-experience" name="experience" required style="width: 100%; padding: 0.75rem; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white;">
                        <option value="">Select Level</option>
                        <option value="Beginner">Sim/Real: Beginner (Just starting)</option>
                        <option value="Intermediate">Sim/Real: Intermediate (Regular Racer)</option>
                        <option value="Advanced">Sim/Real: Advanced (Competitive Racer)</option>
                        <option value="Professional">Sim/Real: Professional / Elite</option>
                        <option value="Real-Life Pro">Real-World Racing Professional</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="onboarding-location">Where are you from?</label>
                    <input type="text" id="onboarding-location" name="location" placeholder="City, Country" required style="width: 100%; padding: 0.75rem; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white;">
                </div>
                <div class="form-group">
                    <label for="onboarding-referral">How did you hear about us?</label>
                    <select id="onboarding-referral" name="referral" required style="width: 100%; padding: 0.75rem; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white;">
                        <option value="">How did you hear about us?</option>
                        <option value="Social Media">Social Media</option>
                        <option value="YouTube">YouTube</option>
                        <option value="Discord">Discord</option>
                        <option value="Friend">Friend / Word of Mouth</option>
                        <option value="Search">Search Engine</option>
                        <option value="Other">Other</option>
                    </select>
                    <textarea id="onboarding-referral-other" name="referral-other" placeholder="Please specify how you heard about us" style="width: 100%; padding: 0.75rem; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: white; margin-top: 0.5rem; display: none; min-height: 80px; resize: vertical; font-family: inherit;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Finish Setup</button>
            </form>
        </div>
    </div>

    <!-- Thank You Modal -->
    <div id="thank-you-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <button id="close-thank-you-modal" class="modal-close">&times;</button>
            <h3 style="margin-bottom: 1rem;">Thank You!</h3>
            <p>Your download has started. We appreciate your interest in Race Insight!</p>
            <button id="close-thank-you-btn" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">Close</button>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content image-modal-content">
            <button id="close-image-modal" class="modal-close">&times;</button>
            <div class="image-modal-container">
                <img id="modal-image" src="" alt="Expanded view" class="modal-image">
            </div>
        </div>
    </div>

    <div class="background-animations">
        <canvas id="track-animation"></canvas>
    </div>

    <script defer src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script>
    <script defer src="js/main.js"></script>
    <script type="module" defer src="js/track-animation.js"></script>
    <!-- Firebase config must load before race-insight.js -->
    <script src="js/firebase-config.js"></script>
    <!-- race-insight.js loads after Firebase scripts and config -->
    <script defer src="js/race-insight.js"></script>

    <script>
        // #region agent log
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if user was logged in via cookies (quick check before Firebase auth restores)
            // Wait for race-insight.js to load getCookie function
            let getCookie = window.getCookie || function(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            };
            const userLoggedIn = getCookie('userLoggedIn');
            if (userLoggedIn === 'true') {
                console.log("Cookie indicates user was logged in, waiting for Firebase auth to restore...");
                // Firebase will restore auth state automatically, we just use cookies as a backup indicator
            }
            
            const authModal = document.getElementById('auth-modal');
            // Ensure modals are hidden initially
            if (authModal) {
                authModal.style.display = 'none';
            } else {
                console.error('Auth modal not found in DOM!');
            }
            const closeAuthModal = document.getElementById('close-auth-modal');
            const googleBtn = document.getElementById('google-signin-btn');
            const emailForm = document.getElementById('email-auth-form');
            const toggleAuthMode = document.getElementById('toggle-auth-mode');
            const authTitle = document.getElementById('auth-title');
            const authSubtitle = document.getElementById('auth-subtitle');
            const emailInput = document.getElementById('auth-email');
            const passwordInput = document.getElementById('auth-password');
            const authError = document.getElementById('auth-error');
            const authSuccess = document.getElementById('auth-success');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const forgotPasswordBtn = document.getElementById('forgot-password-btn');
            const authSubmitBtn = document.getElementById('auth-submit-btn');

            let isSignUp = false;
            let pendingDownloadAction = null;
            let isNewUserSignup = false; // Track if this is a new user signup

            // Helper function to show error
            function showAuthError(message) {
                authError.textContent = message;
                authError.style.display = 'block';
                authSuccess.style.display = 'none';
            }

            // Helper function to show success
            function showAuthSuccess(message) {
                authSuccess.textContent = message;
                authSuccess.style.display = 'block';
                authError.style.display = 'none';
            }

            // Helper function to hide messages
            function hideAuthMessages() {
                authError.style.display = 'none';
                authSuccess.style.display = 'none';
            }

            // Helper function to reset modal to sign-in state
            function resetAuthModalToSignIn() {
                isSignUp = false;
                const titleEl = document.getElementById('auth-title');
                const subtitleEl = document.getElementById('auth-subtitle');
                const submitBtnEl = document.getElementById('auth-submit-btn');
                const switchTextEl = document.getElementById('auth-switch-text');
                const forgotPwdLinkEl = document.getElementById('forgot-password-link');
                const confirmPwdGroup = document.getElementById('confirm-password-group');
                const confirmPwdInput = document.getElementById('auth-confirm-password');
                
                if (titleEl) titleEl.textContent = "Sign In with Google";
                if (subtitleEl) subtitleEl.textContent = "Sign in with your Google account to access downloads and save your preferences.";
                if (submitBtnEl) submitBtnEl.textContent = "Sign In";
                if (switchTextEl) switchTextEl.innerHTML = 'Don\'t have an account? <a href="#" id="toggle-auth-mode">Sign Up</a>';
                if (forgotPwdLinkEl) forgotPwdLinkEl.style.display = 'block';
                if (confirmPwdGroup) {
                    confirmPwdGroup.style.display = 'none';
                    if (confirmPwdInput) {
                        confirmPwdInput.required = false;
                        confirmPwdInput.value = '';
                    }
                }
                hideAuthMessages();
            }

            // Create or update user profile in Firestore
            // Always resolves successfully, even if Firestore operations fail (offline mode)
            async function createUserProfile(user, additionalData = {}) {
                try {
                    const userRef = db.collection('users').doc(user.uid);
                    
                    // Try to get user document, but don't fail if offline or API not enabled
                    let snapshot;
                    try {
                        snapshot = await userRef.get();
                    } catch (getError) {
                        // Handle different error types
                        if (getError.code === 'permission-denied') {
                            console.warn('Firestore permission denied. Make sure Firestore database is created and security rules allow access:', getError.message);
                        } else if (getError.code === 'failed-precondition') {
                            console.warn('Firestore API may not be fully enabled yet. Please wait a few minutes:', getError.message);
                        } else {
                            console.warn('Firestore get() failed (offline/API issue), will attempt to create profile:', getError.message);
                        }
                        snapshot = { exists: false };
                    }

                    if (!snapshot.exists) {
                        // Create new user profile
                        const { displayName, email, photoURL } = user;
                        const createdAt = new Date();
                        try {
                            await userRef.set({
                                displayName: displayName || email.split('@')[0],
                                email,
                                photoURL: photoURL || '',
                                createdAt,
                                bio: '',
                                location: '',
                                simulator: additionalData.simulator || 'Not selected',
                                experience: additionalData.experience || 'Not selected',
                                referral: additionalData.referral || 'Not selected',
                                downloadCount: 0,
                                sessionCount: 0,
                                lastLogin: createdAt,
                                ...additionalData
                            });
                            console.log('User profile created successfully');
                            return { isNewUser: true };
                        } catch (setError) {
                            // ... existing catch ...
                        }
                    } else {
                        // Update existing user profile
                        const currentData = snapshot.data();
                        await userRef.update({
                            lastLogin: new Date(),
                            sessionCount: (currentData.sessionCount || 0) + 1
                        });
                        console.log('User profile updated successfully');
                        return { isNewUser: false };
                    }
                    return { isNewUser: false };
                } catch (error) {
                    console.warn('Firestore operation failed (non-fatal):', error.message);
                    return { isNewUser: false };
                }
            }

            // Onboarding Logic
            const onboardingModal = document.getElementById('onboarding-modal');
            const onboardingForm = document.getElementById('onboarding-form');

            async function checkOnboarding(user, profileResult) {
                if (!onboardingModal) {
                    console.warn("Onboarding modal not found");
                    return;
                }
                
                if (profileResult && profileResult.isNewUser) {
                    console.log("Showing onboarding modal for new user");
                    onboardingModal.style.display = 'flex';
                    onboardingModal.offsetHeight;
                    setTimeout(() => {
                        onboardingModal.classList.add('active');
                    }, 10);
                }
            }

            if (onboardingForm) {
                onboardingForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const user = firebase.auth().currentUser;
                    if (!user) return;

                    const simulatorEl = document.getElementById('onboarding-simulator');
                    const experienceEl = document.getElementById('onboarding-experience');
                    const locationEl = document.getElementById('onboarding-location');
                    const referralEl = document.getElementById('onboarding-referral');
                    
                    if (!simulatorEl || !experienceEl || !locationEl || !referralEl) {
                        console.error('Onboarding form elements not found');
                        return;
                    }

                    const simulator = simulatorEl.value;
                    const experience = experienceEl.value;
                    const location = locationEl.value;
                    const referral = referralEl.value;

                    try {
                        await db.collection('users').doc(user.uid).update({
                            simulator: simulator,
                            experience: experience,
                            location: location,
                            referral: referral
                        });
                        
                        // Close onboarding modal
                        if (onboardingModal) {
                            onboardingModal.classList.remove('active');
                            setTimeout(() => {
                                onboardingModal.style.display = 'none';
                            
                                // Execute pending download action after onboarding completes
                                if (pendingDownloadAction) {
                                    setTimeout(() => {
                                        pendingDownloadAction();
                                        pendingDownloadAction = null;
                                    }, 100);
                                }
                            }, 300);
                        }
                        
                        await loadProfileData(user);
                    } catch (error) {
                        console.error('Error saving onboarding data:', error);
                        alert('Failed to save information. You can update it later in your profile.');
                        if (onboardingModal) {
                            onboardingModal.classList.remove('active');
                            setTimeout(() => {
                                onboardingModal.style.display = 'none';
                                
                                // Still execute download action even if onboarding fails
                                if (pendingDownloadAction) {
                                    setTimeout(() => {
                                        pendingDownloadAction();
                                        pendingDownloadAction = null;
                                    }, 100);
                                }
                            }, 300);
                        }
                    }
                });
            }


            // Load user profile data
            async function loadUserProfile(user) {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        return userDoc.data();
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
                return null;
            }

            // Update UI for logged in user (defined before use)
            function updateUIForLoggedInUser(user) {
                console.log("=== updateUIForLoggedInUser called ===");
                try {
                    const navProfileBtn = document.getElementById('nav-profile-btn');
                    const mobileNavProfileBtn = document.getElementById('mobile-nav-profile-btn');
                    const navSignInBtn = document.getElementById('nav-signin-btn');
                    const downloadBtns = document.querySelectorAll('a[href="#download"]');

                    console.log("Elements found:", {
                        navProfileBtn: !!navProfileBtn,
                        mobileNavProfileBtn: !!mobileNavProfileBtn,
                        navSignInBtn: !!navSignInBtn,
                        downloadBtns: downloadBtns.length
                    });

                    // Hide sign-in button
                    if (navSignInBtn) {
                        navSignInBtn.style.setProperty('display', 'none', 'important');
                    }

                    // Show profile icon buttons in nav
                    if (navProfileBtn) {
                        navProfileBtn.style.setProperty('display', 'inline-flex', 'important');
                        console.log("✓ navProfileBtn shown");
                    }
                    if (mobileNavProfileBtn) {
                        mobileNavProfileBtn.style.setProperty('display', 'block', 'important');
                        console.log("✓ mobileNavProfileBtn shown");
                    }

                    // Update download button text
                    downloadBtns.forEach(btn => {
                        btn.textContent = "Download";
                    });

                    // Update simulator and experience in profile
                    loadProfileData(user);
                    
                    console.log("=== UI update complete ===");
                } catch (error) {
                    console.error("Error in updateUIForLoggedInUser:", error);
                }
            }

            // Sign-in button functionality
            const navSignInBtn = document.getElementById('nav-signin-btn');
            if (navSignInBtn) {
                navSignInBtn.addEventListener('click', () => {
                    resetAuthModalToSignIn();
                    if (authModal) {
                        authModal.style.display = 'flex';
                        authModal.offsetHeight;
                        setTimeout(() => authModal.classList.add('active'), 10);
                    }
                });
            }

            // Ensure profile buttons are hidden initially (before auth state is determined)
            // Show sign-in button by default (will be hidden if user is logged in)
            const navSignInBtnDefault = document.getElementById('nav-signin-btn');
            if (navSignInBtnDefault) {
                navSignInBtnDefault.style.display = 'inline-block';
            }
            updateUIForLoggedOutUser();

            // Monitor Auth State
            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    console.log("=== User is signed in:", user.email, "===");
                    
                    // Store login state in cookies
                    setCookie('userLoggedIn', 'true', 30);
                    setCookie('userEmail', user.email || '', 30);
                    setCookie('userId', user.uid || '', 30);
                    
                    // Try to create/update profile, but don't fail if Firestore is offline
                    let profileResult = null;
                    try {
                        profileResult = await createUserProfile(user);
                    } catch (profileError) {
                        console.error("Profile creation error in auth state change (non-fatal):", profileError);
                    }
                    
                    // Update UI first
                    try {
                        console.log("About to call updateUIForLoggedInUser");
                        updateUIForLoggedInUser(user);
                        console.log("updateUIForLoggedInUser call completed");
                    } catch (error) {
                        console.error("Error calling updateUIForLoggedInUser:", error);
                    }
                    
                    // Close modal with slight delay to show success message
                    if (authModal) {
                        console.log("Closing modal, active class:", authModal.classList.contains('active'));
                        
                        // Wait a bit longer if it's a new signup to show success message
                        const delay = isNewUserSignup ? 1500 : 800;
                        
                        setTimeout(() => {
                            // Remove active class to trigger fade out
                            authModal.classList.remove('active');
                            // Hide modal after animation
                            setTimeout(() => {
                                authModal.style.setProperty('display', 'none', 'important');
                                console.log("✓ Modal display set to none");
                                
                                // Reset modal to sign-in state
                                resetAuthModalToSignIn();
                                
                                // Check if we need to show onboarding for new users
                                // Use isNewUserSignup flag OR check if profile was just created
                                const shouldShowOnboarding = isNewUserSignup || (profileResult && profileResult.isNewUser);
                                
                                if (shouldShowOnboarding) {
                                    console.log("Showing onboarding for new user");
                                    setTimeout(() => {
                                        checkOnboarding(user, { isNewUser: true });
                                    }, 100);
                                } else {
                                    // Execute pending download action if not showing onboarding
                                    if (pendingDownloadAction) {
                                        setTimeout(() => {
                                            pendingDownloadAction();
                                            pendingDownloadAction = null;
                                        }, 100);
                                    }
                                }
                                
                                // Reset the flag
                                isNewUserSignup = false;
                            }, 300);
                        }, delay);
                    }
                } else {
                    console.log("=== User is signed out ===");
                    
                    // Clear login cookies
                    deleteCookie('userLoggedIn');
                    deleteCookie('userEmail');
                    deleteCookie('userId');
                    
                    updateUIForLoggedOutUser();
                    // Ensure modal is hidden when logged out
                    if (authModal) {
                        authModal.classList.remove('active');
                        authModal.style.setProperty('display', 'none', 'important');
                    }
                }
            });

            // Close Modal
            if (closeAuthModal) {
                closeAuthModal.addEventListener('click', () => {
                    // Reset Google button state when closing modal
                    if (googleBtn) resetGoogleButton();
                    
                    // Reset confirm password field
                    const confirmPwdInput = document.getElementById('auth-confirm-password');
                    const confirmPwdGroup = document.getElementById('confirm-password-group');
                    if (confirmPwdInput) confirmPwdInput.value = '';
                    if (confirmPwdGroup) confirmPwdGroup.style.display = 'none';
                    
                    if (authModal) {
                        authModal.classList.remove('active');
                        setTimeout(() => {
                            authModal.style.display = 'none';
                        }, 300);
                    }
                });
            }

            // Update UI for logged out user
            function updateUIForLoggedOutUser() {
                const navProfileBtn = document.getElementById('nav-profile-btn');
                const mobileNavProfileBtn = document.getElementById('mobile-nav-profile-btn');
                const navSignInBtn = document.getElementById('nav-signin-btn');

                // Hide profile buttons when logged out
                if (navProfileBtn) {
                    navProfileBtn.style.setProperty('display', 'none', 'important');
                }
                if (mobileNavProfileBtn) {
                    mobileNavProfileBtn.style.setProperty('display', 'none', 'important');
                }

                // Show sign-in button when logged out
                if (navSignInBtn) {
                    navSignInBtn.style.setProperty('display', 'inline-block', 'important');
                }
            }

            // Toggle Sign In / Sign Up
            const confirmPasswordGroup = document.getElementById('confirm-password-group');
            const confirmPasswordInput = document.getElementById('auth-confirm-password');
            const authSwitchText = document.getElementById('auth-switch-text');
            
            // Use event delegation on the parent to handle clicks on dynamically updated link
            if (authSwitchText) {
                authSwitchText.addEventListener('click', (e) => {
                    const link = e.target.closest('#toggle-auth-mode') || (e.target.id === 'toggle-auth-mode' ? e.target : null);
                    if (link) {
                        e.preventDefault();
                        hideAuthMessages();
                        isSignUp = !isSignUp;
                        if (isSignUp) {
                            if (authTitle) authTitle.textContent = "Create Account";
                            if (authSubtitle) authSubtitle.textContent = "Join Race Insight to start downloading.";
                            if (authSubmitBtn) authSubmitBtn.textContent = "Create Account";
                            authSwitchText.innerHTML = 'Already have an account? <a href="#" id="toggle-auth-mode">Sign In</a>';
                            if (forgotPasswordLink) forgotPasswordLink.style.display = 'none';
                            if (confirmPasswordGroup) confirmPasswordGroup.style.display = 'block';
                            if (confirmPasswordInput) confirmPasswordInput.required = true;
                        } else {
                            if (authTitle) authTitle.textContent = "Sign In with Google";
                            if (authSubtitle) authSubtitle.textContent = "Sign in with your Google account to access downloads and save your preferences.";
                            if (authSubmitBtn) authSubmitBtn.textContent = "Sign In";
                            authSwitchText.innerHTML = 'Don\'t have an account? <a href="#" id="toggle-auth-mode">Sign Up</a>';
                            if (forgotPasswordLink) forgotPasswordLink.style.display = 'block';
                            if (confirmPasswordGroup) confirmPasswordGroup.style.display = 'none';
                            if (confirmPasswordInput) {
                                confirmPasswordInput.required = false;
                                confirmPasswordInput.value = '';
                            }
                        }
                    }
                });
            }

            // Store original Google button HTML
            const googleBtnOriginalHTML = googleBtn ? googleBtn.innerHTML : '';
            
            // Function to reset Google button to original state
            function resetGoogleButton() {
                if (googleBtn) {
                    googleBtn.disabled = false;
                    googleBtn.innerHTML = googleBtnOriginalHTML;
                }
            }
            
            // Google Sign In
            if (googleBtn) {
                googleBtn.addEventListener('click', () => {
                hideAuthMessages();
                
                // Disable the Google button to prevent multiple clicks
                googleBtn.disabled = true;
                googleBtn.innerHTML = '<span style="opacity: 0.7;">Signing in...</span>';
                
                // Set a timeout to restore button if sign-in takes too long (60 seconds)
                const timeoutId = setTimeout(() => {
                    console.warn("Google sign-in timeout - restoring button");
                    resetGoogleButton();
                    showAuthError("Sign in took too long. Please check if popup was blocked and try again.");
                }, 60000);
                
                const provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().signInWithPopup(provider)
                    .then(async (result) => {
                        clearTimeout(timeoutId);
                        console.log("Google sign-in successful:", result.user.email);
                        const profileResult = await createUserProfile(result.user).catch(() => {
                            console.warn("Profile creation completed with warnings (non-fatal)");
                            return { isNewUser: false };
                        });
                        
                        if (profileResult && profileResult.isNewUser) {
                            await checkOnboarding(result.user, profileResult);
                        }
                        // Sign-in succeeded - modal will close via onAuthStateChanged
                        // Button will be reset when modal reopens, so no need to restore here
                    })
                    .catch((error) => {
                        clearTimeout(timeoutId);
                        console.error("Google Sign In Error:", error);
                        
                        // Re-enable the button
                        resetGoogleButton();
                        
                        // Handle different error types
                        let errorMessage = "Sign in failed. Please try again.";
                        
                        if (error.code) {
                            if (error.code === 'auth/popup-closed-by-user') {
                                errorMessage = "Sign in was cancelled. Please try again.";
                            } else if (error.code === 'auth/popup-blocked') {
                                errorMessage = "Popup was blocked. Please allow popups for this site and try again.";
                            } else if (error.code === 'auth/cancelled-popup-request') {
                                errorMessage = "Only one popup request is allowed at a time. Please try again.";
                            } else if (error.code === 'auth/network-request-failed') {
                                errorMessage = "Network error. Please check your connection and try again.";
                            } else if (error.code.startsWith('auth/')) {
                                errorMessage = "Authentication error: " + error.message;
                            } else {
                                errorMessage = "Sign in error: " + error.message;
                            }
                        }
                        
                        showAuthError(errorMessage);
                    });
            });

            // Forgot Password - DISABLED (email auth removed)
            if (false && forgotPasswordBtn) { // Disabled - email auth removed
                forgotPasswordBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const email = emailInput ? emailInput.value.trim() : '';
                    if (!email) {
                        showAuthError("Please enter your email address first.");
                        return;
                    }
                    hideAuthMessages();
                    firebase.auth().sendPasswordResetEmail(email)
                        .then(() => {
                            showAuthSuccess("Password reset email sent! Check your inbox.");
                        })
                        .catch((error) => {
                            console.error("Password Reset Error:", error);
                            showAuthError("Failed to send password reset email: " + error.message);
                        });
                });
            }

            // Email Sign In / Sign Up - DISABLED (only Google auth enabled)
            // Email authentication has been disabled. Only Google sign-in is available.
            if (false && emailForm) { // Disabled - email auth removed
                emailForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    hideAuthMessages();
                    const email = emailInput.value.trim();
                    const password = passwordInput.value;
                    const confirmPassword = confirmPasswordInput.value;

                    if (!email || !password) {
                        showAuthError("Please fill in all fields.");
                        return;
                    }

                    // Validate password confirmation for signup
                    if (isSignUp) {
                        if (!confirmPassword) {
                            showAuthError("Please confirm your password.");
                            return;
                        }
                        if (password !== confirmPassword) {
                            showAuthError("Passwords do not match.");
                            return;
                        }
                    }

                    if (authSubmitBtn) {
                        authSubmitBtn.disabled = true;
                        authSubmitBtn.textContent = isSignUp ? "Creating Account..." : "Signing In...";
                    }

                    if (isSignUp) {
                        firebase.auth().createUserWithEmailAndPassword(email, password)
                            .then(async (userCredential) => {
                                // Mark as new user signup - this will be used in onAuthStateChanged
                                isNewUserSignup = true;
                                
                                // Try to create profile, but don't fail sign-up if it errors
                                try {
                                    await createUserProfile(userCredential.user);
                                } catch (profileError) {
                                    console.error("Profile creation error (non-fatal):", profileError);
                                }
                                
                                // Show success message
                                showAuthSuccess("Account created successfully! Logging you in...");
                                
                                // Clear form fields
                                if (emailInput) emailInput.value = '';
                                if (passwordInput) passwordInput.value = '';
                                if (confirmPasswordInput) confirmPasswordInput.value = '';
                                
                                // Note: User is automatically signed in by Firebase after createUserWithEmailAndPassword
                                // The onAuthStateChanged handler will take care of closing modal and showing onboarding
                                
                                if (authSubmitBtn) {
                                    authSubmitBtn.textContent = "Create Account";
                                    authSubmitBtn.disabled = false;
                                }
                            })
                            .catch((error) => {
                                console.error("Sign Up Error:", error);
                                showAuthError(getErrorMessage(error));
                                if (authSubmitBtn) {
                                    authSubmitBtn.textContent = "Create Account";
                                    authSubmitBtn.disabled = false;
                                }
                                isNewUserSignup = false; // Reset flag on error
                            });
                    } else {
                        firebase.auth().signInWithEmailAndPassword(email, password)
                            .then(async (userCredential) => {
                                // Try to create/update profile, but don't fail sign-in if it errors
                                try {
                                    await createUserProfile(userCredential.user);
                                } catch (profileError) {
                                    console.error("Profile creation error (non-fatal):", profileError);
                                }
                                
                                // Show success message briefly
                                showAuthSuccess("Signing in...");
                                
                                // Clear form fields
                                if (emailInput) emailInput.value = '';
                                if (passwordInput) passwordInput.value = '';
                                
                                // Note: User is automatically signed in by Firebase
                                // The onAuthStateChanged handler will take care of closing modal
                                
                                if (authSubmitBtn) {
                                    authSubmitBtn.textContent = "Sign In";
                                    authSubmitBtn.disabled = false;
                                }
                            })
                            .catch((error) => {
                                console.error("Sign In Error:", error);
                                showAuthError(getErrorMessage(error));
                                if (authSubmitBtn) {
                                    authSubmitBtn.textContent = "Sign In";
                                    authSubmitBtn.disabled = false;
                                }
                            });
                    }
                });
            }

            // Helper function to get user-friendly error messages
            function getErrorMessage(error) {
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        return 'This email is already registered. Please sign in instead.';
                    case 'auth/invalid-email':
                        return 'Invalid email address.';
                    case 'auth/operation-not-allowed':
                        return 'This operation is not allowed.';
                    case 'auth/weak-password':
                        return 'Password should be at least 6 characters.';
                    case 'auth/user-disabled':
                        return 'This account has been disabled.';
                    case 'auth/user-not-found':
                        return 'No account found with this email. Please sign up first.';
                    case 'auth/wrong-password':
                        return 'Incorrect password. Please try again.';
                    case 'auth/invalid-login-credentials':
                        return 'Invalid email or password. Please check your credentials and try again.';
                    case 'auth/invalid-credential':
                        return 'Invalid email or password. Please check your credentials and try again.';
                    default:
                        return error.message || 'An error occurred. Please try again.';
                }
            }

            // Sign-in is now triggered by the Download button when user is not signed in
            // Auth buttons removed - users sign in via download button

            // Logout functionality (only in profile modal)
            const logoutBtns = [
                document.getElementById('modal-logout-btn')
            ];
            logoutBtns.forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        firebase.auth().signOut().then(() => {
                            console.log("User signed out");
                            // Close modals if open
                            if (profileModal) {
                                profileModal.classList.remove('active');
                                setTimeout(() => profileModal.style.display = 'none', 300);
                            }
                            // Clear login cookies
                            deleteCookie('userLoggedIn');
                            deleteCookie('userEmail');
                            deleteCookie('userId');
                        }).catch((error) => {
                            console.error("Sign out error:", error);
                        });
                    });
                }
            });

            // --- Download Counter Logic ---
            const downloadCountElement = document.getElementById('download-count');
            
            // Function to format number with commas
            function formatNumber(num) {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
            
            // Function to animate number change
            function animateCount(element, targetCount) {
                const currentCount = parseInt(element.textContent.replace(/,/g, '')) || 0;
                const increment = targetCount > currentCount ? 1 : -1;
                const duration = 1000; // 1 second
                const steps = 30;
                const stepValue = Math.abs(targetCount - currentCount) / steps;
                const stepDuration = duration / steps;
                
                let current = currentCount;
                const timer = setInterval(() => {
                    current += increment * stepValue;
                    if ((increment > 0 && current >= targetCount) || (increment < 0 && current <= targetCount)) {
                        current = targetCount;
                        clearInterval(timer);
                    }
                    element.textContent = formatNumber(Math.round(current));
                }, stepDuration);
            }
            
            // Fetch and display download count
            const downloadCountRef = db.collection('stats').doc('downloads');
            const totalDownloadContainer = document.getElementById('total-download-container');
            const DOWNLOAD_THRESHOLD = 50; // Big number threshold
            
            // Listen for real-time updates
            downloadCountRef.onSnapshot((doc) => {
                if (doc && doc.exists) {
                    const count = doc.data().count || 0;
                    
                    if (count >= DOWNLOAD_THRESHOLD) {
                        if (totalDownloadContainer) totalDownloadContainer.style.display = 'block';
                        
                        const currentText = downloadCountElement.textContent.trim();
                        const currentCount = parseInt(currentText.replace(/,/g, '')) || 0;
                        
                        if (currentText === 'Loading...' || currentText === '') {
                            downloadCountElement.textContent = formatNumber(count);
                        } else if (count !== currentCount) {
                            animateCount(downloadCountElement, count);
                        }
                    } else {
                        if (totalDownloadContainer) totalDownloadContainer.style.display = 'none';
                    }
                } else {
                    if (totalDownloadContainer) totalDownloadContainer.style.display = 'none';
                }
            }, (error) => {
                console.error('Error fetching download count:', error);
                downloadCountElement.innerHTML = '<span style="opacity: 0.5;">Unable to load</span>';
            });
            
            // Function to increment download count
            async function incrementDownloadCount() {
                try {
                    await db.runTransaction(async (transaction) => {
                        const doc = await transaction.get(downloadCountRef);
                        if (doc && doc.exists) {
                            const currentCount = doc.data().count || 0;
                            transaction.update(downloadCountRef, {
                                count: currentCount + 1
                            });
                        } else {
                            transaction.set(downloadCountRef, {
                                count: 1
                            });
                        }
                    });
                } catch (error) {
                    console.error('Error incrementing download count:', error);
                }
            }

            // --- Download Logic ---
            const downloadBtn = document.getElementById('download-btn');
            const navDownloadBtn = document.getElementById('nav-download-btn');
            const mobileNavDownloadBtn = document.getElementById('mobile-nav-download-btn');
            const platformBtns = document.querySelectorAll('.platform-btn');
            let selectedPlatform = null;

            // Auto-select Windows on page load
            const windowsBtn = document.querySelector('.platform-btn[data-platform="windows"]');
            if (windowsBtn) {
                windowsBtn.classList.add('selected');
                selectedPlatform = 'windows';
            }

            // Ensure platform buttons are clickable
            platformBtns.forEach(btn => {
                // Remove any pointer-events blocking
                btn.style.pointerEvents = 'auto';
                btn.style.cursor = 'pointer';
                btn.style.position = 'relative';
                btn.style.zIndex = '10';
                
                // Remove disabled attribute if it exists (except for actually disabled buttons)
                if (!btn.classList.contains('disabled') && btn.dataset.platform === 'windows') {
                    btn.disabled = false;
                }
                
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // Prevent clicking on disabled buttons
                    if (btn.disabled || btn.classList.contains('disabled')) {
                        console.log('Button is disabled, ignoring click');
                        return;
                    }
                    platformBtns.forEach(b => {
                        if (b !== btn) b.classList.remove('selected');
                    });
                    btn.classList.add('selected');
                    selectedPlatform = btn.dataset.platform;
                    console.log('Platform selected:', selectedPlatform);
                });
                
                // Also handle mousedown for better responsiveness
                btn.addEventListener('mousedown', (e) => {
                    if (!btn.disabled && !btn.classList.contains('disabled')) {
                        e.preventDefault();
                    }
                });
            });

            // Function to handle download button click (opens modal if not logged in)
            function handleDownloadClick(e) {
                if (e) e.preventDefault();
                const user = firebase.auth().currentUser;
                if (!user) {
                    pendingDownloadAction = () => {
                        // Scroll to download section and trigger download
                        const downloadSection = document.getElementById('download');
                        if (downloadSection) {
                            downloadSection.scrollIntoView({ behavior: 'smooth' });
                            setTimeout(() => {
                                if (downloadBtn) downloadBtn.click();
                            }, 500);
                        }
                    };
                    resetAuthModalToSignIn();
                    if (authModal) {
                        authModal.style.display = 'flex';
                        authModal.offsetHeight;
                        setTimeout(() => authModal.classList.add('active'), 10);
                    }
                    return;
                }
                // If logged in, scroll to download section
                const downloadSection = document.getElementById('download');
                if (downloadSection) {
                    downloadSection.scrollIntoView({ behavior: 'smooth' });
                }
            }

            // Add event listeners to nav download buttons
            if (navDownloadBtn) {
                navDownloadBtn.addEventListener('click', handleDownloadClick);
            }
            if (mobileNavDownloadBtn) {
                mobileNavDownloadBtn.addEventListener('click', handleDownloadClick);
            }
            // Also handle other download links
            document.querySelectorAll('a[href="#download"]').forEach(link => {
                if (link.id !== 'nav-download-btn' && link.id !== 'mobile-nav-download-btn') {
                    link.addEventListener('click', handleDownloadClick);
                }
            });

            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => {
                    if (!selectedPlatform) {
                        alert('Please select your platform (Windows, Linux, or Mac) first.');
                        return;
                    }
                    const user = firebase.auth().currentUser;
                    if (!user) {
                        pendingDownloadAction = () => triggerDownload();
                        resetAuthModalToSignIn();
                        if (authModal) {
                            authModal.style.display = 'flex';
                            authModal.offsetHeight;
                            setTimeout(() => authModal.classList.add('active'), 10);
                        }
                        return;
                    }
                    triggerDownload();
                });
            }

            // Helper function to show thank you modal
            function showThankYouModal() {
                const thankYouModal = document.getElementById('thank-you-modal');
                if (thankYouModal) {
                    thankYouModal.style.display = 'flex';
                    thankYouModal.offsetHeight;
                    setTimeout(() => thankYouModal.classList.add('active'), 10);
                }
            }

            async function triggerDownload() {
                // ===== GitHub Releases API (Primary method for PUBLIC repositories) =====
                // Repository is now public: https://github.com/APEX-Race-Tech/RACE-Insight-Public
                // This method automatically fetches the LATEST release - no manual updates needed!
                // When you publish a new release on GitHub, it will automatically be used here.
                
                const GITHUB_OWNER = 'APEX-Race-Tech';
                const GITHUB_REPO = 'RACE-Insight-Public';
                
                const filePatterns = {
                    'windows': /RACE-Insight.*Setup.*\.exe$/i,
                    'linux': /RaceInsight.*\.AppImage$/i,
                    'apple': /RaceInsight.*\.dmg$/i
                };
                
                try {
                    const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/releases/latest`);
                    
                    if (!response.ok) {
                        throw new Error(`GitHub API error: ${response.status}`);
                    }
                    
                    const release = await response.json();
                    const pattern = filePatterns[selectedPlatform];
                    const asset = release.assets.find(asset => pattern.test(asset.name));
                    
                    if (!asset) {
                        // Fallback to hardcoded URLs if API doesn't find the asset
                        throw new Error(`No release file found for ${selectedPlatform}`);
                    }
                    
                    // Open download immediately (synchronously) to avoid popup blocker
                    console.log(`Downloading ${asset.name} (${release.tag_name}) from GitHub Releases`);
                    
                    const link = document.createElement('a');
                    link.href = asset.browser_download_url;
                    link.download = asset.name;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Do async operations after opening the download (non-blocking)
                    try {
                        // Increment download count (fire and forget - don't block download)
                        incrementDownloadCount().catch(error => {
                            console.error('Error incrementing download count:', error);
                        });
                        
                        // Increment user download count (fire and forget)
                        const user = firebase.auth().currentUser;
                        if (user) {
                            db.collection('users').doc(user.uid).update({
                                downloadCount: firebase.firestore.FieldValue.increment(1)
                            }).catch(error => {
                                console.error('Error updating user download count:', error);
                            });
                        }
                        
                        // Show thank you modal
                        showThankYouModal();
                        
                    } catch (error) {
                        console.error('Download tracking error:', error);
                        // Don't show error to user - download already started
                    }
                    
                } catch (error) {
                    console.error('GitHub API download error:', error);
                    
                    // ===== Fallback: Direct Download URLs =====
                    // Fallback to hardcoded URLs if GitHub API fails
                    const downloadUrls = {
                        'windows': 'https://github.com/APEX-Race-Tech/RACE-Insight-Public/releases/download/v0.1.27/RACE-Insight-Setup-0.1.27.exe',
                        'linux': 'https://github.com/APEX-Race-Tech/RACE-Insight-Public/releases/download/v0.1.27/RaceInsight_Setup_Linux.AppImage',
                        'apple': 'https://github.com/APEX-Race-Tech/RACE-Insight-Public/releases/download/v0.1.27/RaceInsight_Setup_Mac.dmg'
                    };
                    
                    const downloadUrl = downloadUrls[selectedPlatform];
                    if (!downloadUrl) {
                        alert('Platform not available yet. Please contact support.');
                        return;
                    }
                    
                    console.log(`Using fallback download URL: ${downloadUrl}`);
                    
                    // Open download immediately (synchronously) to avoid popup blocker
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Do async operations after opening the download (non-blocking)
                    try {
                        incrementDownloadCount().catch(error => {
                            console.error('Error incrementing download count:', error);
                        });
                        
                        const user = firebase.auth().currentUser;
                        if (user) {
                            db.collection('users').doc(user.uid).update({
                                downloadCount: firebase.firestore.FieldValue.increment(1)
                            }).catch(error => {
                                console.error('Error updating user download count:', error);
                            });
                        }
                        
                        showThankYouModal();
                        
                    } catch (trackingError) {
                        console.error('Download tracking error:', trackingError);
                    }
                }
            }

            // --- Thank You Modal Functionality ---
            const thankYouModal = document.getElementById('thank-you-modal');
            const closeThankYouModal = document.getElementById('close-thank-you-modal');
            const closeThankYouBtn = document.getElementById('close-thank-you-btn');

            function closeThankYouModalFunc() {
                if (thankYouModal) {
                    thankYouModal.classList.remove('active');
                    setTimeout(() => {
                        thankYouModal.style.setProperty('display', 'none', 'important');
                    }, 300);
                }
            }

            if (closeThankYouModal) {
                closeThankYouModal.addEventListener('click', closeThankYouModalFunc);
            }

            if (closeThankYouBtn) {
                closeThankYouBtn.addEventListener('click', closeThankYouModalFunc);
            }

            // Close modal when clicking backdrop
            if (thankYouModal) {
                thankYouModal.addEventListener('click', (e) => {
                    if (e.target === thankYouModal) {
                        closeThankYouModalFunc();
                    }
                });
            }

            // --- Profile Modal Functionality ---
            const profileModal = document.getElementById('profile-modal');
            const closeProfileModal = document.getElementById('close-profile-modal');
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const changePasswordBtn = document.getElementById('change-password-btn');
            const profileEditForm = document.getElementById('profile-edit-form');
            const changePasswordForm = document.getElementById('change-password-form');
            const updateProfileForm = document.getElementById('update-profile-form');
            const updatePasswordForm = document.getElementById('update-password-form');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const cancelPasswordBtn = document.getElementById('cancel-password-btn');

            // Close Profile Modal
            if (closeProfileModal) {
                closeProfileModal.addEventListener('click', () => {
                    profileModal.classList.remove('active');
                    setTimeout(() => {
                        profileModal.style.setProperty('display', 'none', 'important');
                    }, 300);
                });
            }

            // Close modal when clicking backdrop
            if (profileModal) {
                profileModal.addEventListener('click', (e) => {
                    if (e.target === profileModal) {
                        profileModal.classList.remove('active');
                        setTimeout(() => {
                            profileModal.style.setProperty('display', 'none', 'important');
                        }, 300);
                    }
                });
            }

            // Navigation to profile (open as modal)
            document.querySelectorAll('a[href="#profile"]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const user = firebase.auth().currentUser;
                    if (user) {
                        if (profileModal) {
                            profileModal.style.display = 'flex';
                            profileModal.offsetHeight;
                            setTimeout(() => profileModal.classList.add('active'), 10);
                            loadProfileData(user);
                        }
                    } else {
                        resetAuthModalToSignIn();
                        if (authModal) {
                            authModal.style.display = 'flex';
                            authModal.offsetHeight;
                            setTimeout(() => authModal.classList.add('active'), 10);
                        }
                    }
                });
            });

            // Profile button click handlers
            const navProfileBtn = document.getElementById('nav-profile-btn');
            const mobileNavProfileBtn = document.getElementById('mobile-nav-profile-btn');
            
            if (navProfileBtn) {
                navProfileBtn.addEventListener('click', () => {
                    const user = firebase.auth().currentUser;
                    if (user) {
                        if (profileModal) {
                            profileModal.style.display = 'flex';
                            profileModal.offsetHeight;
                            setTimeout(() => profileModal.classList.add('active'), 10);
                            loadProfileData(user);
                        }
                    } else {
                        resetAuthModalToSignIn();
                        if (authModal) {
                            authModal.style.display = 'flex';
                            authModal.offsetHeight;
                            setTimeout(() => authModal.classList.add('active'), 10);
                        }
                    }
                });
            }

            if (mobileNavProfileBtn) {
                mobileNavProfileBtn.addEventListener('click', () => {
                    const user = firebase.auth().currentUser;
                    if (user) {
                        if (profileModal) {
                            profileModal.style.display = 'flex';
                            profileModal.offsetHeight;
                            setTimeout(() => profileModal.classList.add('active'), 10);
                            loadProfileData(user);
                        }
                    } else {
                        resetAuthModalToSignIn();
                        if (authModal) {
                            authModal.style.display = 'flex';
                            authModal.offsetHeight;
                            setTimeout(() => authModal.classList.add('active'), 10);
                        }
                    }
                });
            }

            // Load and display profile data
            async function loadProfileData(user) {
                try {
                    const profileData = await loadUserProfile(user);
                    const displayName = document.getElementById('profile-display-name');
                    const profileEmail = document.getElementById('profile-email');
                    const memberSince = document.getElementById('profile-member-since');
                    const avatarInitials = document.getElementById('profile-avatar-initials');
                    const avatarImg = document.getElementById('profile-avatar-img');
                    const statDownloads = document.getElementById('stat-downloads');
                    const statSessions = document.getElementById('stat-sessions');

                    if (displayName) displayName.textContent = profileData?.displayName || user.displayName || user.email.split('@')[0];
                    if (profileEmail) profileEmail.textContent = user.email;
                    if (memberSince && profileData?.createdAt) {
                        const date = profileData.createdAt.toDate ? profileData.createdAt.toDate() : new Date(profileData.createdAt);
                        memberSince.textContent = `Member since: ${date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}`;
                    }

                    // Avatar
                    if (user.photoURL || profileData?.photoURL) {
                        avatarImg.src = user.photoURL || profileData.photoURL;
                        avatarImg.style.display = 'block';
                        avatarInitials.style.display = 'none';
                    } else {
                        const initials = (profileData?.displayName || user.displayName || user.email.split('@')[0])
                            .split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                        avatarInitials.textContent = initials;
                        avatarInitials.style.display = 'flex';
                        avatarImg.style.display = 'none';
                    }

                    // Stats
                    if (statSessions) statSessions.textContent = profileData?.sessionCount || 0;
                    
                    const profileSim = document.getElementById('profile-simulator');
                    const profileExp = document.getElementById('profile-experience');
                    const profileRef = document.getElementById('profile-referral');
                    const profileLoc = document.getElementById('profile-location-display');
                    if (profileSim) profileSim.textContent = profileData?.simulator || 'Not selected';
                    if (profileExp) profileExp.textContent = profileData?.experience || 'Not selected';
                    if (profileRef) profileRef.textContent = profileData?.referral || 'Not selected';
                    if (profileLoc) profileLoc.textContent = profileData?.location || 'Not selected';

                    // Pre-fill edit form
                    if (document.getElementById('profile-name')) {
                        document.getElementById('profile-name').value = profileData?.displayName || user.displayName || '';
                    }
                    if (document.getElementById('profile-bio')) {
                        document.getElementById('profile-bio').value = profileData?.bio || '';
                    }
                    if (document.getElementById('profile-location')) {
                        document.getElementById('profile-location').value = profileData?.location || '';
                    }
                    if (document.getElementById('profile-simulator-edit')) {
                        document.getElementById('profile-simulator-edit').value = profileData?.simulator || '';
                    }
                    if (document.getElementById('profile-experience-edit')) {
                        document.getElementById('profile-experience-edit').value = profileData?.experience || '';
                    }
                } catch (error) {
                    console.error('Error loading profile data:', error);
                }
            }

            // Edit profile button
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', () => {
                    if (profileEditForm) profileEditForm.style.display = 'block';
                    if (changePasswordForm) changePasswordForm.style.display = 'none';
                });
            }

            // Change password button
            if (changePasswordBtn) {
                changePasswordBtn.addEventListener('click', () => {
                    if (changePasswordForm) changePasswordForm.style.display = 'block';
                    if (profileEditForm) profileEditForm.style.display = 'none';
                });
            }

            // Cancel edit
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', () => {
                    if (profileEditForm) profileEditForm.style.display = 'none';
                });
            }

            // Cancel password change
            if (cancelPasswordBtn) {
                cancelPasswordBtn.addEventListener('click', () => {
                    if (changePasswordForm) changePasswordForm.style.display = 'none';
                    if (updatePasswordForm) updatePasswordForm.reset();
                });
            }

            // Update profile form
            if (updateProfileForm) {
                updateProfileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const user = firebase.auth().currentUser;
                    if (!user) return;

                    const nameEl = document.getElementById('profile-name');
                    const bioEl = document.getElementById('profile-bio');
                    const locationEl = document.getElementById('profile-location');
                    const simulatorEl = document.getElementById('profile-simulator-edit');
                    const experienceEl = document.getElementById('profile-experience-edit');
                    
                    if (!nameEl || !bioEl || !locationEl || !simulatorEl || !experienceEl) {
                        console.error('Profile form elements not found');
                        return;
                    }
                    
                    const displayName = nameEl.value.trim();
                    const bio = bioEl.value.trim();
                    const location = locationEl.value.trim();
                    const simulator = simulatorEl.value;
                    const experience = experienceEl.value;
 
                    try {
                        await db.collection('users').doc(user.uid).update({
                            displayName: displayName || user.email.split('@')[0],
                            bio: bio,
                            location: location,
                            simulator: simulator,
                            experience: experience
                        });

                        // Update Firebase Auth display name
                        if (displayName && displayName !== user.displayName) {
                            await user.updateProfile({ displayName: displayName });
                        }

                        if (profileEditForm) profileEditForm.style.display = 'none';
                        await loadProfileData(user);
                        alert('Profile updated successfully!');
                    } catch (error) {
                        console.error('Error updating profile:', error);
                        alert('Failed to update profile: ' + error.message);
                    }
                });
            }

            // Update password form
            if (updatePasswordForm) {
                updatePasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const user = firebase.auth().currentUser;
                    if (!user) return;

                    const currentPwdEl = document.getElementById('current-password');
                    const newPwdEl = document.getElementById('new-password');
                    
                    if (!currentPwdEl || !newPwdEl) {
                        console.error('Password form elements not found');
                        return;
                    }
                    
                    const currentPassword = currentPwdEl.value;
                    const newPassword = newPwdEl.value;
                    const confirmPwdEl = document.getElementById('confirm-password');
                    if (!confirmPwdEl) {
                        console.error('Confirm password field not found');
                        return;
                    }
                    const confirmPassword = confirmPwdEl.value;

                    if (newPassword !== confirmPassword) {
                        alert('New passwords do not match!');
                        return;
                    }

                    if (newPassword.length < 6) {
                        alert('Password must be at least 6 characters long!');
                        return;
                    }

                    try {
                        // Re-authenticate user
                        const credential = firebase.auth.EmailAuthProvider.credential(
                            user.email,
                            currentPassword
                        );
                        await user.reauthenticateWithCredential(credential);

                        // Update password
                        await user.updatePassword(newPassword);
                        if (updatePasswordForm) updatePasswordForm.reset();
                        if (changePasswordForm) changePasswordForm.style.display = 'none';
                        alert('Password updated successfully!');
                    } catch (error) {
                        console.error('Error updating password:', error);
                        alert('Failed to update password: ' + getErrorMessage(error));
                    }
                });
            }

            // Delete Account Logic
            const deleteAccountBtn = document.getElementById('delete-account-btn');
            if (deleteAccountBtn) {
                deleteAccountBtn.addEventListener('click', async () => {
                    const user = firebase.auth().currentUser;
                    if (!user) return;

                    const confirmed = confirm("WARNING: This will permanently delete your account and all associated data. This action cannot be undone. Are you sure?");
                    
                    if (confirmed) {
                        try {
                            // 1. Delete Firestore data
                            await db.collection('users').doc(user.uid).delete();
                            console.log("User data deleted from Firestore");

                            // 2. Delete Firebase Auth user
                            await user.delete();
                            console.log("User account deleted");

                            alert("Your account has been successfully deleted.");
                            
                            // 3. UI cleanup
                            if (profileModal) {
                                profileModal.classList.remove('active');
                                setTimeout(() => profileModal.style.display = 'none', 300);
                            }
                            deleteCookie('userLoggedIn');
                            deleteCookie('userEmail');
                            deleteCookie('userId');
                            location.reload(); // Refresh to update nav/state
                        } catch (error) {
                            console.error("Error deleting account:", error);
                            if (error.code === 'auth/requires-recent-login') {
                                alert("For security reasons, this action requires a recent login. Please log out and log back in, then try again.");
                            } else {
                                alert("Failed to delete account: " + error.message);
                            }
                        }
                    }
                });
            }

            // --- Shrunk Navigation Icons Functionality ---
            // Removed - shrunk nav icons container has been removed

            // Auth step navigation buttons (for potential two-step signup flow)
            // Note: These are kept for potential future two-step signup flow
            // Currently, signup is handled in one step via auth-submit-btn
            const authNextBtn = document.getElementById('auth-next-btn');
            const authBackBtn = document.getElementById('auth-back-btn');
            const authSignupSubmitBtn = document.getElementById('auth-signup-submit-btn');
            const authStep1 = document.getElementById('auth-step-1');
            const authStep2 = document.getElementById('auth-step-2');
            const authStepIndicator = document.getElementById('auth-step-indicator');

            if (authNextBtn && authStep1 && authStep2) {
                authNextBtn.addEventListener('click', () => {
                    // Get input elements
                    const emailInputEl = document.getElementById('auth-email');
                    const passwordInputEl = document.getElementById('auth-password');
                    const confirmPasswordInputEl = document.getElementById('auth-confirm-password');
                    
                    // Validate step 1 fields before proceeding
                    const email = emailInputEl ? emailInputEl.value.trim() : '';
                    const password = passwordInputEl ? passwordInputEl.value : '';
                    const confirmPassword = confirmPasswordInputEl ? confirmPasswordInputEl.value : '';
                    
                    if (!email || !password) {
                        showAuthError("Please fill in email and password.");
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        showAuthError("Passwords do not match.");
                        return;
                    }
                    
                    // Hide step 1, show step 2
                    if (authStep1) authStep1.style.display = 'none';
                    if (authStep2) authStep2.style.display = 'block';
                    if (authStepIndicator) authStepIndicator.style.display = 'block';
                });
            }

            if (authBackBtn && authStep1 && authStep2) {
                authBackBtn.addEventListener('click', () => {
                    // Go back to step 1
                    if (authStep2) authStep2.style.display = 'none';
                    if (authStep1) authStep1.style.display = 'block';
                    if (authStepIndicator) authStepIndicator.style.display = 'none';
                });
            }

            if (authSignupSubmitBtn && authStep2) {
                authSignupSubmitBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // This would handle the second step of signup
                    // Currently, signup is handled in one step via auth-submit-btn
                    // This is kept for potential future two-step flow
                    console.log('Two-step signup submit clicked (not currently active)');
                });
            }

            // Innovative Card Functionality (works for all style variations)
            function initInnovativeCards() {
                // Get all feature sections with any innovative style
                const styleSelectors = [
                    '.feature-details.style-overlapping',
                    '.feature-details.style-accordion',
                    '.feature-details.style-glassmorphism',
                    '.feature-details.style-particles',
                    '.feature-details.style-isometric',
                    '.feature-details.style-minimal',
                    '.feature-details.innovative-layout'
                ];
                
                styleSelectors.forEach(selector => {
                    const layouts = document.querySelectorAll(selector);
                    
                    layouts.forEach(layout => {
                        const cards = layout.querySelectorAll('.innovative-card');
                        
                        cards.forEach(card => {
                            card.addEventListener('click', function(e) {
                                // Don't trigger card activation if clicking on image wrapper
                                if (e.target.closest('.card-image-wrapper')) {
                                    return;
                                }
                                // Remove active class from all cards in this layout
                                cards.forEach(c => c.classList.remove('active'));
                                // Add active class to clicked card
                                this.classList.add('active');
                            });
                        });
                    });
                });
            }

            // Initialize innovative cards
            initInnovativeCards();

            // --- Image Modal Functionality ---
            function initImageModal() {
                const imageModal = document.getElementById('image-modal');
                const modalImage = document.getElementById('modal-image');
                const closeImageModal = document.getElementById('close-image-modal');
                const imageWrappers = document.querySelectorAll('.card-image-wrapper');

                if (!imageModal || !modalImage) return;

                // Function to open image modal
                function openImageModal(imageSrc, imageAlt) {
                    modalImage.src = imageSrc;
                    modalImage.alt = imageAlt || 'Expanded view';
                    imageModal.style.display = 'flex';
                    imageModal.offsetHeight; // Force reflow
                    setTimeout(() => imageModal.classList.add('active'), 10);
                    document.body.style.overflow = 'hidden'; // Prevent scrolling
                }

                // Function to close image modal
                function closeImageModalFunc() {
                    imageModal.classList.remove('active');
                    setTimeout(() => {
                        imageModal.style.display = 'none';
                        document.body.style.overflow = ''; // Restore scrolling
                    }, 300);
                }

                // Add click handlers to all image wrappers
                imageWrappers.forEach(wrapper => {
                    wrapper.addEventListener('click', function(e) {
                        e.stopPropagation(); // Prevent card click event
                        const img = wrapper.querySelector('.card-image');
                        if (img && img.src) {
                            openImageModal(img.src, img.alt);
                        }
                    });
                });

                // Close modal handlers
                if (closeImageModal) {
                    closeImageModal.addEventListener('click', closeImageModalFunc);
                }

                // Close modal when clicking backdrop
                imageModal.addEventListener('click', function(e) {
                    if (e.target === imageModal) {
                        closeImageModalFunc();
                    }
                });

                // Close modal on Escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && imageModal.classList.contains('active')) {
                        closeImageModalFunc();
                    }
                });
            }

            // Initialize image modal
            // initImageModal(); // Disabled - image expanded modal is not needed

            // --- Hero Slideshow Functionality ---
            function initSlideshow() {
                const slides = document.querySelectorAll('.slide');
                const indicators = document.querySelectorAll('.indicator');
                const prevBtn = document.querySelector('.slideshow-prev');
                const nextBtn = document.querySelector('.slideshow-next');
                
                // Check if slides exist
                if (!slides || slides.length === 0) {
                    console.warn('No slides found for slideshow');
                    return;
                }
                
                let currentSlide = 0;
                let slideshowInterval;
                let isAnimating = false;

                // Function to show a specific slide with card shuffle animation
                function showSlide(index, direction = 'next', skipAnimation = false) {
                    // Normalize index
                    index = index % slides.length;
                    if (index < 0) index = slides.length + index;
                    
                    // Skip if already on this slide (unless it's initial setup)
                    if (!skipAnimation && (isAnimating || index === currentSlide)) return;
                    isAnimating = true;

                    const prevIndex = currentSlide;
                    const prevSlideEl = slides[prevIndex];
                    const nextSlideEl = slides[index];

                    if (!prevSlideEl || !nextSlideEl) {
                        isAnimating = false;
                        return;
                    }

                    // Remove all classes from slides
                    slides.forEach(slide => {
                        slide.classList.remove('active', 'prev', 'next');
                    });

                    // Remove active class from indicators
                    indicators.forEach(indicator => indicator.classList.remove('active'));

                    // Set initial transform positions based on direction
                    if (direction === 'next') {
                        // Next slide starts from right
                        nextSlideEl.style.transform = 'translateX(100%) scale(0.95)';
                        nextSlideEl.style.opacity = '0';
                        nextSlideEl.style.transition = 'none';
                    } else {
                        // Next slide starts from left
                        nextSlideEl.style.transform = 'translateX(-100%) scale(0.95)';
                        nextSlideEl.style.opacity = '0';
                        nextSlideEl.style.transition = 'none';
                    }

                    // Force reflow to apply initial position
                    void nextSlideEl.offsetWidth;

                    // Enable transitions and animate
                    prevSlideEl.style.transition = 'all 0.7s cubic-bezier(0.4, 0, 0.2, 1)';
                    nextSlideEl.style.transition = 'all 0.7s cubic-bezier(0.4, 0, 0.2, 1)';

                    // Animate to final positions
                    requestAnimationFrame(() => {
                        if (direction === 'next') {
                            prevSlideEl.style.transform = 'translateX(-100%) scale(0.95)';
                            prevSlideEl.style.opacity = '0';
                        } else {
                            prevSlideEl.style.transform = 'translateX(100%) scale(0.95)';
                            prevSlideEl.style.opacity = '0';
                        }

                        nextSlideEl.style.transform = 'translateX(0) scale(1)';
                        nextSlideEl.style.opacity = '1';

                        // After animation completes
                        setTimeout(() => {
                            // Clean up and set final state
                            prevSlideEl.classList.remove('active');
                            prevSlideEl.style.transform = '';
                            prevSlideEl.style.opacity = '';
                            prevSlideEl.style.transition = '';

                            nextSlideEl.classList.add('active');
                            nextSlideEl.style.transform = '';
                            nextSlideEl.style.opacity = '';
                            nextSlideEl.style.transition = '';
                            
                            // Update current slide index
                            currentSlide = index;
                            
                            // Update indicators
                            if (indicators[currentSlide]) {
                                indicators[currentSlide].classList.add('active');
                            }

                            // Update prev/next classes
                            updatePrevNextClasses();
                            
                            isAnimating = false;
                        }, 700);
                    });
                }

                // Update prev/next classes for visual effect
                function updatePrevNextClasses() {
                    slides.forEach((slide, index) => {
                        slide.classList.remove('prev', 'next');
                        if (index === currentSlide) return;
                        
                        const prevIndex = (currentSlide - 1 + slides.length) % slides.length;
                        const nextIndex = (currentSlide + 1) % slides.length;
                        
                        if (index === prevIndex) {
                            slide.classList.add('prev');
                        } else if (index === nextIndex) {
                            slide.classList.add('next');
                        }
                    });
                }

                // Function to go to next slide
                function nextSlide() {
                    if (isAnimating) {
                        console.log('Already animating, skipping nextSlide');
                        return;
                    }
                    const nextIndex = (currentSlide + 1) % slides.length;
                    console.log('Moving to next slide:', nextIndex, 'from', currentSlide);
                    showSlide(nextIndex, 'next');
                }

                // Function to go to previous slide
                function prevSlide() {
                    const prevIndex = (currentSlide - 1 + slides.length) % slides.length;
                    showSlide(prevIndex, 'prev');
                }

                // Function to start auto-play
                function startAutoPlay() {
                    // Clear any existing interval first
                    if (slideshowInterval) {
                        clearInterval(slideshowInterval);
                    }
                    slideshowInterval = setInterval(() => {
                        if (!isAnimating) {
                            nextSlide();
                        }
                    }, 5000); // Change slide every 5 seconds
                    console.log('Auto-play started, interval:', slideshowInterval);
                }

                // Function to stop auto-play
                function stopAutoPlay() {
                    if (slideshowInterval) {
                        clearInterval(slideshowInterval);
                        slideshowInterval = null;
                        console.log('Auto-play stopped');
                    }
                }

                // Event listeners for navigation buttons
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        nextSlide();
                        stopAutoPlay();
                        startAutoPlay(); // Restart auto-play after manual navigation
                    });
                }

                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        prevSlide();
                        stopAutoPlay();
                        startAutoPlay(); // Restart auto-play after manual navigation
                    });
                }

                // Event listeners for indicators
                indicators.forEach((indicator, index) => {
                    indicator.addEventListener('click', () => {
                        if (index === currentSlide) return;
                        
                        // Determine direction based on index
                        const direction = index > currentSlide ? 'next' : 'prev';
                        showSlide(index, direction);
                        stopAutoPlay();
                        startAutoPlay(); // Restart auto-play after manual navigation
                    });
                });

                // Pause auto-play on hover
                const slideshowContainer = document.querySelector('.slideshow-container');
                if (slideshowContainer) {
                    slideshowContainer.addEventListener('mouseenter', stopAutoPlay);
                    slideshowContainer.addEventListener('mouseleave', startAutoPlay);
                }

                // Initialize - show first slide and start auto-play
                // Set initial state without animation
                slides.forEach((slide, index) => {
                    // Remove all classes and inline styles
                    slide.classList.remove('active', 'prev', 'next');
                    slide.style.transform = '';
                    slide.style.opacity = '';
                    slide.style.transition = '';
                    
                    if (index === 0) {
                        // First slide is active
                        slide.classList.add('active');
                        slide.style.opacity = '1';
                        slide.style.transform = 'translateX(0) scale(1)';
                    } else if (index === slides.length - 1) {
                        // Last slide is prev
                        slide.classList.add('prev');
                        slide.style.opacity = '0';
                        slide.style.transform = 'translateX(-100%) scale(0.95)';
                    } else if (index === 1) {
                        // Second slide is next
                        slide.classList.add('next');
                        slide.style.opacity = '0';
                        slide.style.transform = 'translateX(100%) scale(0.95)';
                    } else {
                        // Other slides hidden
                        slide.style.opacity = '0';
                        slide.style.transform = 'translateX(100%) scale(0.95)';
                    }
                });
                
                // Set first indicator as active
                indicators.forEach((indicator, index) => {
                    indicator.classList.remove('active');
                    if (index === 0) {
                        indicator.classList.add('active');
                    }
                });
                
                // Update prev/next classes
                updatePrevNextClasses();
                
                // Reset animation flag
                isAnimating = false;
                
                // Start auto-play after a short delay to ensure DOM is ready
                setTimeout(() => {
                    if (slideshowInterval) {
                        clearInterval(slideshowInterval);
                    }
                    startAutoPlay();
                    console.log('Slideshow auto-play started');
                }, 2000);
            }
            
            // Call initSlideshow to initialize the slideshow
            initSlideshow();
        });
    </script>

    <script>
        // #region agent log
        (function() {
            const log = (hypothesisId, message, data) => {
                fetch('http://127.0.0.1:7243/ingest/a0857f31-9c4c-4a58-b6c0-704ab032f313', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: 'race-insight.html:debug-script-icons',
                        message: message,
                        data: data,
                        timestamp: Date.now(),
                        sessionId: 'debug-session-icons',
                        hypothesisId: hypothesisId
                    })
                }).catch(() => {});
            };

            const checkIcons = () => {
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    const overlays = document.querySelectorAll('.style-minimal .image-overlay');
                    overlays.forEach((overlay, i) => {
                        const icon = overlay.querySelector('i');
                        const overlayStyle = window.getComputedStyle(overlay);
                        
                        let iconData = null;
                        if (icon) {
                            const iconStyle = window.getComputedStyle(icon);
                            const iconRect = icon.getBoundingClientRect();
                            iconData = {
                                display: iconStyle.display,
                                visibility: iconStyle.visibility,
                                opacity: iconStyle.opacity,
                                fontSize: iconStyle.fontSize,
                                color: iconStyle.color,
                                zIndex: iconStyle.zIndex,
                                rect: { width: iconRect.width, height: iconRect.height, top: iconRect.top, left: iconRect.left }
                            };
                        }

                        log('A/B/C/D', `Card ${i} Icon Check`, {
                            overlay: {
                                display: overlayStyle.display,
                                opacity: overlayStyle.opacity,
                                zIndex: overlayStyle.zIndex,
                                backgroundColor: overlayStyle.backgroundColor
                            },
                            icon: iconData
                        });
                    });
                }
            };

            window.addEventListener('load', checkIcons);
            setTimeout(checkIcons, 2000);
        })();
        // #endregion
    </script>
    <div style="text-align: right; font-size: 0.85rem; color: #888; margin-bottom: 1.5rem; padding: 0 2rem;">
        Made with ❤️‍🔥 From 🇮🇳
    </div>
    <div class="footer-content">
        <p>&copy; 2026 APEX Race Technologies. All rights reserved.</p>
        <div style="margin-top: 1rem; font-size: 0.9rem;">
            <a href="https://docs.apexracetech.in" target="_blank" rel="noopener noreferrer" style="color: #bbb; text-decoration: none; margin-right: 1rem;">Documentation</a>
            <a href="race-insight/eula.html" style="color: #bbb; text-decoration: none; margin-right: 1rem;">EULA</a>
            <a href="race-insight/terms.html" style="color: #bbb; text-decoration: none; margin-right: 1rem;">Terms of Service</a>
            <a href="race-insight/privacy-policy.html" style="color: #bbb; text-decoration: none;">Privacy Policy</a>
        </div>
    </div>
</body>

</html>