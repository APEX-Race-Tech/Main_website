<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Insight | APEX Race Technologies</title>
    <meta name="description" content="Download Race Insight - The advanced telemetry analysis tool for sim racers.">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/race-insight.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TQNN66RBKN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-TQNN66RBKN');
    </script>
</head>

<body>
    <header class="header">
        <nav class="nav-container">
            <a href="index.html" class="header__logo">
                <img src="assets/images/apex_orange_Horizontal.svg" alt="APEX Race Technologies Logo" class="logo--full"
                    style="filter: hue-rotate(190deg) brightness(1.2);">
                <img src="assets/images/apex_orange_ONLY LOGO.svg" alt="APEX Race Technologies Icon" class="logo--icon"
                    style="filter: hue-rotate(190deg) brightness(1.2);">
            </a>
            <div class="nav-right">
                <ul class="nav-links">
                    <li><a href="https://docs.apexracetech.in" target="_blank" rel="noopener noreferrer">Docs</a></li>
                    <li id="nav-profile" style="display: none;"><a href="#profile">Profile</a></li>
                </ul>
                <div class="header-action-item">
                    <button id="nav-profile-btn" class="btn-profile-icon" aria-label="Profile" title="Profile">
                        <i class="fas fa-user"></i>
                    </button>
                    <button id="nav-auth-btn" class="btn btn-primary">Sign In</button>
                    <a href="#download" class="btn btn-primary" id="nav-download-btn">Download</a>
                    <button id="nav-logout-btn" class="btn btn-secondary" style="display: none;">Logout</button>
                </div>
            </div>
            <button class="hamburger-btn" aria-label="Toggle menu">
                <span class="hamburger-btn__bar"></span>
                <span class="hamburger-btn__bar"></span>
                <span class="hamburger-btn__bar"></span>
            </button>
        </nav>
    </header>

    <div class="mobile-nav">
        <ul class="nav-links">
            <li><a href="https://docs.apexracetech.in" target="_blank" rel="noopener noreferrer">Docs</a></li>
            <li id="mobile-nav-profile" style="display: none;"><a href="#profile">Profile</a></li>
        </ul>
        <div class="header-action-item">
            <button id="mobile-nav-profile-btn" class="btn-profile-icon" style="margin-bottom: 0.5rem;" aria-label="Profile">
                <i class="fas fa-user"></i>
            </button>
            <button id="mobile-nav-auth-btn" class="btn btn-primary" style="margin-bottom: 0.5rem; width: 100%;">Sign In</button>
            <a href="#download" class="btn btn-primary" id="mobile-nav-download-btn">Download</a>
            <button id="mobile-nav-logout-btn" class="btn btn-secondary" style="display: none; margin-top: 0.5rem; width: 100%;">Logout</button>
        </div>
    </div>

    <section id="race-insight-hero" class="full-page-section">
        <div class="section-content">
            <div class="hero-logo-container">
                <img src="assets/app_icon.png" alt="Race Insight Logo" class="hero-logo" decoding="async">
            </div>
            <div class="hero-text-wrapper">
                <h1 class="hero-title">Race Insight</h1>
                <p class="tagline">The Ultimate Sim Racing Telemetry Tool</p>
                <div class="hero-content">
                    <p class="hero-description">Analyze your laps, compare telemetry, and improve your lap times with
                        professional-grade data analysis.</p>
                    <div class="hero-actions">
                        <a href="#download" class="btn btn-primary">Get Started</a>
                        <a href="#features" class="btn btn-secondary">Learn More</a>
                    </div>
                    <div class="hero-badge">Now Available in Beta</div>
                </div>
            </div>
        </div>
    </section>
]

    <section id="features" class="full-page-section">
        <div class="section-content">
            <div class="advantage-cards">
                <div class="advantage-card feature-card">
                    <img src="assets/images/lap_comparison_ui.png" alt="Lap Comparison" class="feature-img">
                    <h4>Lap Comparison</h4>
                    <p>Compare multiple laps side-by-side to identify time gains and losses.</p>
                </div>
                <div class="advantage-card feature-card">
                    <img src="assets/images/telemetry_graphs_ui.png" alt="Telemetry Analysis" class="feature-img">
                    <h4>Advanced Telemetry</h4>
                    <p>Dive deep into speed, throttle, brake, and steering data with precise graphs.</p>
                </div>
                <div class="advantage-card feature-card">
                    <img src="assets/images/track_map_ui.png" alt="Track Mapping" class="feature-img">
                    <h4>Interactive Track Map</h4>
                    <p>Visualize your racing line and position on the track in real-time.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="upcoming-updates" class="full-page-section">
        <div class="section-content">
            <h2 class="section-title">Coming Soon</h2>
            <p class="section-subtitle">We are constantly working to improve Race Insight. Here is what's next:</p>
            <div class="updates-grid">
                <div class="update-card">
                    <div class="update-icon"><i class="fas fa-video"></i></div>
                    <h4>Video Support</h4>
                    <p>Sync your onboard video with telemetry data for visual analysis.</p>
                </div>
                <div class="update-card">
                    <div class="update-icon"><i class="fas fa-globe"></i></div>
                    <h4>Full Web App</h4>
                    <p>Access your data from any device with our upcoming cloud-based web application.</p>
                </div>
                <div class="update-card">
                    <div class="update-icon"><i class="fas fa-stopwatch-20"></i></div>
                    <h4>Predictive Laps</h4>
                    <p>Real-time predictive lap timing to help you push your limits.</p>
                </div>
                <div class="update-card">
                    <div class="update-icon"><i class="fas fa-chart-line"></i></div>
                    <h4>Advanced Data Analysis</h4>
                    <p>AI-powered insights to suggest setup changes and driving improvements.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="download" class="full-page-section">
        <div class="section-content">
            <div class="download-section">
                <h3>Download Race Insight</h3>
                <p>Choose your platform and start analyzing your racing data.</p>

                <div class="download-counter" style="margin: 1.5rem 0; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; text-align: center;">
                    <p style="margin: 0; font-size: 0.9rem; color: #aaa; margin-bottom: 0.5rem;">Total Downloads</p>
                    <div id="download-count" style="font-size: 2rem; font-weight: 700; color: #fff; font-variant-numeric: tabular-nums;">
                        <span style="opacity: 0.5;">Loading...</span>
                    </div>
                </div>

                <div class="platform-options">
                    <button class="platform-btn" data-platform="windows"><i class="fab fa-windows"></i> Windows</button>
                    <button class="platform-btn disabled" data-platform="linux" disabled style="opacity: 0.5; cursor: not-allowed; pointer-events: none;"><i class="fab fa-linux"></i> Linux</button>
                    <button class="platform-btn disabled" data-platform="apple" disabled style="opacity: 0.5; cursor: not-allowed; pointer-events: none;"><i class="fab fa-apple"></i> Mac</button>
                    <button class="platform-btn disabled" data-platform="android" disabled style="opacity: 0.5; cursor: not-allowed; pointer-events: none;"><i class="fab fa-android"></i> Android</button>
                </div>

                <div class="action-buttons">
                    <button id="download-btn" class="btn btn-primary">Download</button>
                </div>
            </div>
        </div>
    </section>

    <section id="profile" class="full-page-section" style="display: none;">
        <div class="section-content">
            <div class="profile-section">
                <h2 class="section-title">Profile</h2>
                <div class="profile-container">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <div id="profile-avatar-initials" class="avatar-initials"></div>
                            <img id="profile-avatar-img" src="" alt="Profile" style="display: none; width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        </div>
                        <div class="profile-info">
                            <h3 id="profile-display-name">Loading...</h3>
                            <p id="profile-email" style="color: var(--text-color-secondary);">Loading...</p>
                            <p id="profile-member-since" style="color: var(--text-color-secondary); font-size: 0.9rem; margin-top: 0.5rem;">Member since: Loading...</p>
                        </div>
                    </div>

                    <div class="profile-actions">
                        <button id="edit-profile-btn" class="btn btn-primary"><i class="fas fa-edit"></i> Edit Profile</button>
                        <button id="change-password-btn" class="btn btn-secondary"><i class="fas fa-key"></i> Change Password</button>
                    </div>

                    <div id="profile-edit-form" class="profile-edit-form" style="display: none;">
                        <h4>Edit Profile</h4>
                        <form id="update-profile-form">
                            <div class="form-group">
                                <label for="profile-name">Display Name</label>
                                <input type="text" id="profile-name" name="displayName" placeholder="Enter your display name">
                            </div>
                            <div class="form-group">
                                <label for="profile-bio">Bio (Optional)</label>
                                <textarea id="profile-bio" name="bio" rows="3" placeholder="Tell us about yourself"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="profile-location">Location (Optional)</label>
                                <input type="text" id="profile-location" name="location" placeholder="City, Country">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <div id="change-password-form" class="profile-edit-form" style="display: none;">
                        <h4>Change Password</h4>
                        <form id="update-password-form">
                            <div class="form-group">
                                <label for="current-password">Current Password</label>
                                <input type="password" id="current-password" name="currentPassword" placeholder="Enter current password" required>
                            </div>
                            <div class="form-group">
                                <label for="new-password">New Password</label>
                                <input type="password" id="new-password" name="newPassword" placeholder="Enter new password" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="confirm-password">Confirm New Password</label>
                                <input type="password" id="confirm-password" name="confirmPassword" placeholder="Confirm new password" required>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Update Password</button>
                                <button type="button" id="cancel-password-btn" class="btn btn-secondary">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <div class="profile-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-downloads">0</div>
                            <div class="stat-label">Downloads</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-sessions">0</div>
                            <div class="stat-label">Sessions</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="feedback" class="full-page-section">
        <div class="section-content">
            <h2 class="section-title">
                <span style="font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem;">Share Your Feedback</span>
                <span style="font-size: 1.1rem; color: var(--text-color-secondary); text-align: center; line-height: 1.6; max-width: 500px;">
                    We value your input and suggestions. Help us improve Race Insight by sharing your thoughts, reporting issues, or suggesting new features.
                </span>
            </h2>
            <form action="https://api.web3forms.com/submit" method="POST" class="contact-form"
                enctype="multipart/form-data">
                <input type="hidden" name="access_key" value="bfe30952-0ac8-4ece-b115-8965465d4035">
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="message">Message</label>
                    <textarea id="message" name="message" rows="5" required></textarea>
                </div>
                <div class="form-group">
                    <label for="attachment">Screenshot (Optional)</label>
                    <input type="file" name="attachment" id="attachment" accept="image/png, image/jpeg"
                        class="file-input">
                </div>
                <button type="submit" class="btn btn-primary">Send Feedback</button>
            </form>
        </div>
    </section>

    <footer>
        <div class="footer-content">
            <p>&copy; 2024 APEX Race Technologies. All rights reserved.</p>
            <div style="margin-top: 1rem; font-size: 0.9rem;">
                <a href="https://docs.apexracetech.in" target="_blank" rel="noopener noreferrer" style="color: #bbb; text-decoration: none; margin-right: 1rem;">Documentation</a>
                <a href="race-insight/eula.html" style="color: #bbb; text-decoration: none; margin-right: 1rem;">EULA</a>
                <a href="race-insight/terms.html" style="color: #bbb; text-decoration: none; margin-right: 1rem;">Terms of Service</a>
                <a href="race-insight/third-party-licenses.html" style="color: #bbb; text-decoration: none; margin-right: 1rem;">Third-Party Licenses</a>
                <a href="race-insight/privacy-policy.html" style="color: #bbb; text-decoration: none;">Privacy Policy</a>
            </div>
        </div>
    </footer>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal-backdrop">
        <div class="modal-content">
            <button id="close-auth-modal" class="modal-close">&times;</button>
            <h3 id="auth-title">Sign In to Download</h3>
            <p id="auth-subtitle">Create an account to access downloads and save your preferences.</p>

            <div class="auth-buttons">
                <button id="google-signin-btn" class="btn-google">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google"
                        width="18">
                    Sign in with Google
                </button>
            </div>

            <div class="divider"><span>OR</span></div>

            <div id="auth-error" class="auth-error" style="display: none; background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3); color: #ff6b6b; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;"></div>
            <div id="auth-success" class="auth-success" style="display: none; background: rgba(0, 255, 0, 0.1); border: 1px solid rgba(0, 255, 0, 0.3); color: #51cf66; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;"></div>

            <form id="email-auth-form">
                <div class="form-group">
                    <input type="email" id="auth-email" placeholder="Email Address" required>
                </div>
                <div class="form-group">
                    <input type="password" id="auth-password" placeholder="Password" required>
                    <div id="forgot-password-link" style="text-align: right; margin-top: 0.5rem; font-size: 0.85rem; display: none;">
                        <a href="#" id="forgot-password-btn" style="color: var(--primary-color); text-decoration: none;">Forgot Password?</a>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="auth-submit-btn">Sign In</button>
            </form>

            <div class="auth-switch">
                <p id="auth-switch-text">Don't have an account? <a href="#" id="toggle-auth-mode">Sign Up</a></p>
            </div>
        </div>
    </div>

    <div class="background-animations">
        <canvas id="track-animation"></canvas>
    </div>

    <script>
        // Force data-section to avoid 'home' logic from stopping animation initially
        document.body.setAttribute('data-section', 'race-insight-hero');

        // Safety: Force content visibility if animation fails
        setTimeout(() => {
            document.querySelectorAll('.animate-on-scroll').forEach(el => {
                if (getComputedStyle(el).opacity === '0') {
                    el.style.opacity = '1';
                    el.style.transform = 'none';
                }
            });
        }, 1000);
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script>
    <script src="js/main.js"></script>
    <script type="module" src="js/track-animation.js"></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB6pcGMJixpwxz4Zls_ghpCPX8RwKd4F5g",
            authDomain: "apex-race-insight-auth.firebaseapp.com",
            projectId: "apex-race-insight-auth",
            storageBucket: "apex-race-insight-auth.firebasestorage.app",
            messagingSenderId: "828112911630",
            appId: "1:828112911630:web:f8364b252c410f21a5eb5f",
            measurementId: "G-4632V21RSD"
        };

        // Initialize Firebase (Compat Syntax)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // Initialize Firestore
        const db = firebase.firestore();

        // --- Auth Logic ---
        document.addEventListener('DOMContentLoaded', async () => {
            const authModal = document.getElementById('auth-modal');
            const closeAuthModal = document.getElementById('close-auth-modal');
            const googleBtn = document.getElementById('google-signin-btn');
            const emailForm = document.getElementById('email-auth-form');
            const toggleAuthMode = document.getElementById('toggle-auth-mode');
            const authTitle = document.getElementById('auth-title');
            const authSubtitle = document.getElementById('auth-subtitle');
            const emailInput = document.getElementById('auth-email');
            const passwordInput = document.getElementById('auth-password');
            const authError = document.getElementById('auth-error');
            const authSuccess = document.getElementById('auth-success');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const forgotPasswordBtn = document.getElementById('forgot-password-btn');
            const authSubmitBtn = document.getElementById('auth-submit-btn');

            let isSignUp = false;
            let pendingDownloadAction = null;

            // Helper function to show error
            function showAuthError(message) {
                authError.textContent = message;
                authError.style.display = 'block';
                authSuccess.style.display = 'none';
            }

            // Helper function to show success
            function showAuthSuccess(message) {
                authSuccess.textContent = message;
                authSuccess.style.display = 'block';
                authError.style.display = 'none';
            }

            // Helper function to hide messages
            function hideAuthMessages() {
                authError.style.display = 'none';
                authSuccess.style.display = 'none';
            }

            // Create or update user profile in Firestore
            // Always resolves successfully, even if Firestore operations fail (offline mode)
            async function createUserProfile(user, additionalData = {}) {
                try {
                    const userRef = db.collection('users').doc(user.uid);
                    
                    // Try to get user document, but don't fail if offline
                    let snapshot;
                    try {
                        snapshot = await userRef.get();
                    } catch (getError) {
                        // If get() fails (e.g., offline), assume document doesn't exist and try to create
                        console.warn('Firestore get() failed (offline), will attempt to create profile:', getError.message);
                        snapshot = { exists: false };
                    }

                    if (!snapshot.exists) {
                        // Create new user profile
                        const { displayName, email, photoURL } = user;
                        const createdAt = new Date();
                        try {
                            await userRef.set({
                                displayName: displayName || email.split('@')[0],
                                email,
                                photoURL: photoURL || '',
                                createdAt,
                                bio: '',
                                location: '',
                                downloadCount: 0,
                                sessionCount: 0,
                                lastLogin: createdAt,
                                ...additionalData
                            });
                            console.log('User profile created successfully');
                        } catch (setError) {
                            // If offline, Firestore will queue this for when connection is restored
                            console.warn('User profile creation queued (offline mode):', setError.message);
                        }
                    } else {
                        // Update existing user profile
                        try {
                            const currentData = snapshot.data();
                            await userRef.update({
                                lastLogin: new Date(),
                                sessionCount: (currentData.sessionCount || 0) + 1
                            });
                            console.log('User profile updated successfully');
                        } catch (updateError) {
                            // If offline, Firestore will queue this for when connection is restored
                            console.warn('User profile update queued (offline mode):', updateError.message);
                        }
                    }
                    return userRef;
                } catch (error) {
                    // Catch any unexpected errors - always resolve successfully
                    console.warn('Firestore operation failed (non-fatal):', error.message);
                    return null;
                }
            }

            // Load user profile data
            async function loadUserProfile(user) {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        return userDoc.data();
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
                return null;
            }

            // Monitor Auth State
            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    console.log("User is signed in:", user.email);
                    // Try to create/update profile, but don't fail if Firestore is offline
                    try {
                        await createUserProfile(user);
                    } catch (profileError) {
                        console.error("Profile creation error in auth state change (non-fatal):", profileError);
                    }
                    await updateUIForLoggedInUser(user);
                    
                    if (authModal.classList.contains('active') || authModal.style.display !== 'none') {
                        authModal.classList.remove('active');
                        setTimeout(() => {
                            authModal.style.display = 'none';
                            if (pendingDownloadAction) {
                                pendingDownloadAction();
                                pendingDownloadAction = null;
                            }
                        }, 300);
                    }
                } else {
                    updateUIForLoggedOutUser();
                }
            });

            // Close Modal
            closeAuthModal.addEventListener('click', () => {
                authModal.classList.remove('active');
                setTimeout(() => authModal.style.display = 'none', 300);
            });

            // Update UI for logged in user
            async function updateUIForLoggedInUser(user) {
                const navProfile = document.getElementById('nav-profile');
                const mobileNavProfile = document.getElementById('mobile-nav-profile');
                const navProfileBtn = document.getElementById('nav-profile-btn');
                const mobileNavProfileBtn = document.getElementById('mobile-nav-profile-btn');
                const navAuthBtn = document.getElementById('nav-auth-btn');
                const mobileNavAuthBtn = document.getElementById('mobile-nav-auth-btn');
                const navLogoutBtn = document.getElementById('nav-logout-btn');
                const mobileNavLogoutBtn = document.getElementById('mobile-nav-logout-btn');
                const downloadBtns = document.querySelectorAll('a[href="#download"]');

                if (navProfile) navProfile.style.display = 'block';
                if (mobileNavProfile) mobileNavProfile.style.display = 'block';
                if (navProfileBtn) {
                    navProfileBtn.style.setProperty('display', 'flex', 'important');
                }
                if (mobileNavProfileBtn) {
                    mobileNavProfileBtn.style.setProperty('display', 'flex', 'important');
                }
                if (navAuthBtn) navAuthBtn.style.display = 'none';
                if (mobileNavAuthBtn) mobileNavAuthBtn.style.display = 'none';
                if (navLogoutBtn) navLogoutBtn.style.display = 'inline-flex';
                if (mobileNavLogoutBtn) mobileNavLogoutBtn.style.display = 'block';

                downloadBtns.forEach(btn => {
                    btn.textContent = "Download";
                });
            }

            // Update UI for logged out user
            function updateUIForLoggedOutUser() {
                const navProfile = document.getElementById('nav-profile');
                const mobileNavProfile = document.getElementById('mobile-nav-profile');
                const navProfileBtn = document.getElementById('nav-profile-btn');
                const mobileNavProfileBtn = document.getElementById('mobile-nav-profile-btn');
                const navAuthBtn = document.getElementById('nav-auth-btn');
                const mobileNavAuthBtn = document.getElementById('mobile-nav-auth-btn');
                const navLogoutBtn = document.getElementById('nav-logout-btn');
                const mobileNavLogoutBtn = document.getElementById('mobile-nav-logout-btn');
                const profileSection = document.getElementById('profile');

                if (navProfile) navProfile.style.display = 'none';
                if (mobileNavProfile) mobileNavProfile.style.display = 'none';
                // Profile button remains visible even when logged out
                if (navProfileBtn) {
                    navProfileBtn.style.setProperty('display', 'flex', 'important');
                }
                if (mobileNavProfileBtn) {
                    mobileNavProfileBtn.style.setProperty('display', 'flex', 'important');
                }
                if (navAuthBtn) navAuthBtn.style.display = 'inline-flex';
                if (mobileNavAuthBtn) mobileNavAuthBtn.style.display = 'block';
                if (navLogoutBtn) navLogoutBtn.style.display = 'none';
                if (mobileNavLogoutBtn) mobileNavLogoutBtn.style.display = 'none';
                if (profileSection) profileSection.style.display = 'none';
            }

            // Toggle Sign In / Sign Up
            toggleAuthMode.addEventListener('click', (e) => {
                e.preventDefault();
                hideAuthMessages();
                isSignUp = !isSignUp;
                if (isSignUp) {
                    authTitle.textContent = "Create Account";
                    authSubtitle.textContent = "Join Race Insight to start downloading.";
                    authSubmitBtn.textContent = "Sign Up";
                    toggleAuthMode.textContent = "Sign In";
                    forgotPasswordLink.style.display = 'none';
                } else {
                    authTitle.textContent = "Sign In to Download";
                    authSubtitle.textContent = "Create an account to access downloads and save your preferences.";
                    authSubmitBtn.textContent = "Sign In";
                    toggleAuthMode.textContent = "Sign Up";
                    forgotPasswordLink.style.display = 'block';
                }
            });

            // Google Sign In
            googleBtn.addEventListener('click', () => {
                hideAuthMessages();
                const provider = new firebase.auth.GoogleAuthProvider();
                authSubmitBtn.disabled = true;
                firebase.auth().signInWithPopup(provider)
                    .then(async (result) => {
                        // createUserProfile always resolves, so this won't cause sign-in to fail
                        await createUserProfile(result.user).catch(() => {
                            // Extra safety - should never reach here, but just in case
                            console.warn("Profile creation completed with warnings (non-fatal)");
                        });
                        // Sign-in succeeded - modal will close via onAuthStateChanged
                    })
                    .catch((error) => {
                        console.error("Google Sign In Error:", error);
                        // Only show error for actual authentication failures, not Firestore errors
                        if (error.code && error.code.startsWith('auth/')) {
                            showAuthError("Google Sign In failed: " + error.message);
                        } else {
                            showAuthError("Sign in error: " + error.message);
                        }
                        authSubmitBtn.disabled = false;
                    });
            });

            // Forgot Password
            forgotPasswordBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const email = emailInput.value.trim();
                if (!email) {
                    showAuthError("Please enter your email address first.");
                    return;
                }
                hideAuthMessages();
                firebase.auth().sendPasswordResetEmail(email)
                    .then(() => {
                        showAuthSuccess("Password reset email sent! Check your inbox.");
                    })
                    .catch((error) => {
                        console.error("Password Reset Error:", error);
                        showAuthError("Failed to send password reset email: " + error.message);
                    });
            });

            // Email Sign In / Sign Up
            emailForm.addEventListener('submit', (e) => {
                e.preventDefault();
                hideAuthMessages();
                const email = emailInput.value.trim();
                const password = passwordInput.value;

                if (!email || !password) {
                    showAuthError("Please fill in all fields.");
                    return;
                }

                authSubmitBtn.disabled = true;
                authSubmitBtn.textContent = isSignUp ? "Creating Account..." : "Signing In...";

                if (isSignUp) {
                    firebase.auth().createUserWithEmailAndPassword(email, password)
                        .then(async (userCredential) => {
                            // Try to create profile, but don't fail sign-up if it errors
                            try {
                                await createUserProfile(userCredential.user);
                            } catch (profileError) {
                                console.error("Profile creation error (non-fatal):", profileError);
                            }
                            showAuthSuccess("Account created successfully!");
                            authSubmitBtn.textContent = "Sign Up";
                            authSubmitBtn.disabled = false;
                        })
                        .catch((error) => {
                            console.error("Sign Up Error:", error);
                            showAuthError(getErrorMessage(error));
                            authSubmitBtn.textContent = "Sign Up";
                            authSubmitBtn.disabled = false;
                        });
                } else {
                    firebase.auth().signInWithEmailAndPassword(email, password)
                        .then(async (userCredential) => {
                            // Try to create/update profile, but don't fail sign-in if it errors
                            try {
                                await createUserProfile(userCredential.user);
                            } catch (profileError) {
                                console.error("Profile creation error (non-fatal):", profileError);
                            }
                            authSubmitBtn.textContent = "Sign In";
                            authSubmitBtn.disabled = false;
                        })
                        .catch((error) => {
                            console.error("Sign In Error:", error);
                            showAuthError(getErrorMessage(error));
                            authSubmitBtn.textContent = "Sign In";
                            authSubmitBtn.disabled = false;
                        });
                }
            });

            // Helper function to get user-friendly error messages
            function getErrorMessage(error) {
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        return 'This email is already registered. Please sign in instead.';
                    case 'auth/invalid-email':
                        return 'Invalid email address.';
                    case 'auth/operation-not-allowed':
                        return 'This operation is not allowed.';
                    case 'auth/weak-password':
                        return 'Password should be at least 6 characters.';
                    case 'auth/user-disabled':
                        return 'This account has been disabled.';
                    case 'auth/user-not-found':
                        return 'No account found with this email. Please sign up first.';
                    case 'auth/wrong-password':
                        return 'Incorrect password. Please try again.';
                    case 'auth/invalid-login-credentials':
                        return 'Invalid email or password. Please check your credentials and try again.';
                    case 'auth/invalid-credential':
                        return 'Invalid email or password. Please check your credentials and try again.';
                    default:
                        return error.message || 'An error occurred. Please try again.';
                }
            }

            // Auth button click handlers (single button for Sign In/Sign Up)
            const authBtns = [document.getElementById('nav-auth-btn'), document.getElementById('mobile-nav-auth-btn')];
            authBtns.forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        // Default to sign in mode
                        isSignUp = false;
                        authTitle.textContent = "Sign In to Download";
                        authSubtitle.textContent = "Create an account to access downloads and save your preferences.";
                        authSubmitBtn.textContent = "Sign In";
                        toggleAuthMode.textContent = "Sign Up";
                        forgotPasswordLink.style.display = 'block';
                        hideAuthMessages();
                        
                        authModal.style.display = 'flex';
                        setTimeout(() => authModal.classList.add('active'), 10);
                    });
                }
            });

            // Logout functionality
            const logoutBtns = [document.getElementById('nav-logout-btn'), document.getElementById('mobile-nav-logout-btn')];
            logoutBtns.forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        firebase.auth().signOut().then(() => {
                            console.log("User signed out");
                        }).catch((error) => {
                            console.error("Sign out error:", error);
                        });
                    });
                }
            });

            // --- Download Counter Logic ---
            const downloadCountElement = document.getElementById('download-count');
            
            // Function to format number with commas
            function formatNumber(num) {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
            
            // Function to animate number change
            function animateCount(element, targetCount) {
                const currentCount = parseInt(element.textContent.replace(/,/g, '')) || 0;
                const increment = targetCount > currentCount ? 1 : -1;
                const duration = 1000; // 1 second
                const steps = 30;
                const stepValue = Math.abs(targetCount - currentCount) / steps;
                const stepDuration = duration / steps;
                
                let current = currentCount;
                const timer = setInterval(() => {
                    current += increment * stepValue;
                    if ((increment > 0 && current >= targetCount) || (increment < 0 && current <= targetCount)) {
                        current = targetCount;
                        clearInterval(timer);
                    }
                    element.textContent = formatNumber(Math.round(current));
                }, stepDuration);
            }
            
            // Fetch and display download count
            const downloadCountRef = db.collection('stats').doc('downloads');
            
            // Listen for real-time updates
            downloadCountRef.onSnapshot((doc) => {
                if (doc.exists()) {
                    const count = doc.data().count || 0;
                    const currentText = downloadCountElement.textContent.trim();
                    const currentCount = parseInt(currentText.replace(/,/g, '')) || 0;
                    
                    if (currentText === 'Loading...' || currentText === '') {
                        downloadCountElement.textContent = formatNumber(count);
                    } else if (count !== currentCount) {
                        animateCount(downloadCountElement, count);
                    }
                } else {
                    // Initialize if document doesn't exist
                    downloadCountRef.set({ count: 0 });
                    downloadCountElement.textContent = '0';
                }
            }, (error) => {
                console.error('Error fetching download count:', error);
                downloadCountElement.innerHTML = '<span style="opacity: 0.5;">Unable to load</span>';
            });
            
            // Function to increment download count
            async function incrementDownloadCount() {
                try {
                    await db.runTransaction(async (transaction) => {
                        const doc = await transaction.get(downloadCountRef);
                        if (doc.exists()) {
                            const currentCount = doc.data().count || 0;
                            transaction.update(downloadCountRef, {
                                count: currentCount + 1
                            });
                        } else {
                            transaction.set(downloadCountRef, {
                                count: 1
                            });
                        }
                    });
                } catch (error) {
                    console.error('Error incrementing download count:', error);
                }
            }

            // --- Download Logic ---
            const downloadBtn = document.getElementById('download-btn');
            const platformBtns = document.querySelectorAll('.platform-btn');
            let selectedPlatform = null;

            // Auto-select Windows on page load
            const windowsBtn = document.querySelector('.platform-btn[data-platform="windows"]');
            if (windowsBtn) {
                windowsBtn.classList.add('selected');
                selectedPlatform = 'windows';
            }

            platformBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Prevent clicking on disabled buttons
                    if (btn.disabled || btn.classList.contains('disabled')) {
                        return;
                    }
                    platformBtns.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedPlatform = btn.dataset.platform;
                });
            });

            downloadBtn.addEventListener('click', () => {
                if (!selectedPlatform) {
                    alert('Please select your platform (Windows, Linux, Mac, or Android) first.');
                    return;
                }
                const user = firebase.auth().currentUser;
                if (!user) {
                    pendingDownloadAction = () => triggerDownload();
                    authModal.style.display = 'flex';
                    setTimeout(() => authModal.classList.add('active'), 10);
                    return;
                }
                triggerDownload();
            });

            async function triggerDownload() {
                let fileName = 'RaceInsight_Setup.exe';
                switch (selectedPlatform) {
                    case 'windows': fileName = 'RaceInsight_Setup_Windows.exe'; break;
                    case 'linux': fileName = 'RaceInsight_Setup_Linux.AppImage'; break;
                    case 'apple': fileName = 'RaceInsight_Setup_Mac.dmg'; break;
                    case 'android': fileName = 'RaceInsight_Setup_Android.apk'; break;
                }
                
                // Increment download count
                await incrementDownloadCount();
                
                // Increment user download count
                const user = firebase.auth().currentUser;
                if (user) {
                    try {
                        await db.collection('users').doc(user.uid).update({
                            downloadCount: firebase.firestore.FieldValue.increment(1)
                        });
                    } catch (error) {
                        console.error('Error updating user download count:', error);
                    }
                }
                
                alert(`Starting download for ${selectedPlatform}: ${fileName} (Placeholder)`);
            }

            // --- Profile Page Functionality ---
            const profileSection = document.getElementById('profile');
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const changePasswordBtn = document.getElementById('change-password-btn');
            const profileEditForm = document.getElementById('profile-edit-form');
            const changePasswordForm = document.getElementById('change-password-form');
            const updateProfileForm = document.getElementById('update-profile-form');
            const updatePasswordForm = document.getElementById('update-password-form');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const cancelPasswordBtn = document.getElementById('cancel-password-btn');

            // Navigation to profile
            document.querySelectorAll('a[href="#profile"]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const user = firebase.auth().currentUser;
                    if (user) {
                        profileSection.style.display = 'block';
                        profileSection.scrollIntoView({ behavior: 'smooth' });
                        loadProfileData(user);
                    } else {
                        authModal.style.display = 'flex';
                        setTimeout(() => authModal.classList.add('active'), 10);
                    }
                });
            });

            // Profile button click handlers
            const navProfileBtn = document.getElementById('nav-profile-btn');
            const mobileNavProfileBtn = document.getElementById('mobile-nav-profile-btn');
            
            if (navProfileBtn) {
                navProfileBtn.addEventListener('click', () => {
                    const user = firebase.auth().currentUser;
                    if (user) {
                        profileSection.style.display = 'block';
                        profileSection.scrollIntoView({ behavior: 'smooth' });
                        loadProfileData(user);
                    } else {
                        authModal.style.display = 'flex';
                        setTimeout(() => authModal.classList.add('active'), 10);
                    }
                });
            }

            if (mobileNavProfileBtn) {
                mobileNavProfileBtn.addEventListener('click', () => {
                    const user = firebase.auth().currentUser;
                    if (user) {
                        profileSection.style.display = 'block';
                        profileSection.scrollIntoView({ behavior: 'smooth' });
                        loadProfileData(user);
                    } else {
                        authModal.style.display = 'flex';
                        setTimeout(() => authModal.classList.add('active'), 10);
                    }
                });
            }

            // Load and display profile data
            async function loadProfileData(user) {
                try {
                    const profileData = await loadUserProfile(user);
                    const displayName = document.getElementById('profile-display-name');
                    const profileEmail = document.getElementById('profile-email');
                    const memberSince = document.getElementById('profile-member-since');
                    const avatarInitials = document.getElementById('profile-avatar-initials');
                    const avatarImg = document.getElementById('profile-avatar-img');
                    const statDownloads = document.getElementById('stat-downloads');
                    const statSessions = document.getElementById('stat-sessions');

                    if (displayName) displayName.textContent = profileData?.displayName || user.displayName || user.email.split('@')[0];
                    if (profileEmail) profileEmail.textContent = user.email;
                    if (memberSince && profileData?.createdAt) {
                        const date = profileData.createdAt.toDate ? profileData.createdAt.toDate() : new Date(profileData.createdAt);
                        memberSince.textContent = `Member since: ${date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}`;
                    }

                    // Avatar
                    if (user.photoURL || profileData?.photoURL) {
                        avatarImg.src = user.photoURL || profileData.photoURL;
                        avatarImg.style.display = 'block';
                        avatarInitials.style.display = 'none';
                    } else {
                        const initials = (profileData?.displayName || user.displayName || user.email.split('@')[0])
                            .split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                        avatarInitials.textContent = initials;
                        avatarInitials.style.display = 'flex';
                        avatarImg.style.display = 'none';
                    }

                    // Stats
                    if (statDownloads) statDownloads.textContent = profileData?.downloadCount || 0;
                    if (statSessions) statSessions.textContent = profileData?.sessionCount || 0;

                    // Pre-fill edit form
                    if (document.getElementById('profile-name')) {
                        document.getElementById('profile-name').value = profileData?.displayName || user.displayName || '';
                    }
                    if (document.getElementById('profile-bio')) {
                        document.getElementById('profile-bio').value = profileData?.bio || '';
                    }
                    if (document.getElementById('profile-location')) {
                        document.getElementById('profile-location').value = profileData?.location || '';
                    }
                } catch (error) {
                    console.error('Error loading profile data:', error);
                }
            }

            // Edit profile button
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', () => {
                    profileEditForm.style.display = 'block';
                    changePasswordForm.style.display = 'none';
                });
            }

            // Change password button
            if (changePasswordBtn) {
                changePasswordBtn.addEventListener('click', () => {
                    changePasswordForm.style.display = 'block';
                    profileEditForm.style.display = 'none';
                });
            }

            // Cancel edit
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', () => {
                    profileEditForm.style.display = 'none';
                });
            }

            // Cancel password change
            if (cancelPasswordBtn) {
                cancelPasswordBtn.addEventListener('click', () => {
                    changePasswordForm.style.display = 'none';
                    updatePasswordForm.reset();
                });
            }

            // Update profile form
            if (updateProfileForm) {
                updateProfileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const user = firebase.auth().currentUser;
                    if (!user) return;

                    const displayName = document.getElementById('profile-name').value.trim();
                    const bio = document.getElementById('profile-bio').value.trim();
                    const location = document.getElementById('profile-location').value.trim();

                    try {
                        await db.collection('users').doc(user.uid).update({
                            displayName: displayName || user.email.split('@')[0],
                            bio: bio,
                            location: location
                        });

                        // Update Firebase Auth display name
                        if (displayName && displayName !== user.displayName) {
                            await user.updateProfile({ displayName: displayName });
                        }

                        profileEditForm.style.display = 'none';
                        await loadProfileData(user);
                        alert('Profile updated successfully!');
                    } catch (error) {
                        console.error('Error updating profile:', error);
                        alert('Failed to update profile: ' + error.message);
                    }
                });
            }

            // Update password form
            if (updatePasswordForm) {
                updatePasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const user = firebase.auth().currentUser;
                    if (!user) return;

                    const currentPassword = document.getElementById('current-password').value;
                    const newPassword = document.getElementById('new-password').value;
                    const confirmPassword = document.getElementById('confirm-password').value;

                    if (newPassword !== confirmPassword) {
                        alert('New passwords do not match!');
                        return;
                    }

                    if (newPassword.length < 6) {
                        alert('Password must be at least 6 characters long!');
                        return;
                    }

                    try {
                        // Re-authenticate user
                        const credential = firebase.auth.EmailAuthProvider.credential(
                            user.email,
                            currentPassword
                        );
                        await user.reauthenticateWithCredential(credential);

                        // Update password
                        await user.updatePassword(newPassword);
                        updatePasswordForm.reset();
                        changePasswordForm.style.display = 'none';
                        alert('Password updated successfully!');
                    } catch (error) {
                        console.error('Error updating password:', error);
                        alert('Failed to update password: ' + getErrorMessage(error));
                    }
                });
            }
        });
    </script>
</body>

</html>